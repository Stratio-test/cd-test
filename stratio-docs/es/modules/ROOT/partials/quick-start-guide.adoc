El propósito de esta guía es explicar de forma sencilla cómo integrar una base de datos en la plataforma _Stratio Generative AI Data Fabric_. Como ejemplo, se va a integrar una instancia de una base de datos MongoDB 4.1.2. Aunque cada base de datos puede requerir un tratamiento específico, los pasos básicos descritos en esta guía son los mismos para todas ellas.

Se va a indicar cómo configurar cada uno de los elementos de _Stratio Generative AI Data Fabric_ para realizar las distintas fases de un proyecto de datos: *descubrimiento de datos* con un agente de _Stratio Data Governance_, *virtualización de datos* con _Stratio Virtualizer_ y *acceso al dato* con _Stratio Rocket_ y _Stratio Intelligence_.

Esto permitirá un uso básico y rápido de los datos que estén almacenados dentro de la base de datos en _Stratio Generative AI Data Fabric_.

Como requisitos previos a la configuración del conector, se necesita:

 * Tener una instancia de una base de datos MongoDB instalada y accesible desde _Stratio Generative AI Data Fabric_.
+
En el ejemplo se usa la URL _mongodb://dbsqa.labs.stratio.com:27017_ con la colección de documentos _sample++_++mflix_ para descubrir.

* xref:connectors-repository:operations-guide.adoc[Instalar el repositorio de conectores].

* Tener accesible la interfaz de usuario de _Stratio KMS_.
+
Para esto se deben seguir estos pasos:

. Crear un Ingress para exponer la interfaz de usuario del servicio _Stratio KMS_. Para llevarlo a cabo puedes crear un _.yaml_ con la información que se incluye debajo:
+
--
* xref:attachment$/kms/kms-ingress.yaml[Ingress]
+
.Ver _script_

[%collapsible]
====

[source,sql]
----
include::attachment$/kms/kms-ingress.yaml[]
----

====
--
+
En este punto, ejecuta:
+
[source,bash]
----
kubectl apply -f <nombre_yaml>.yaml
----

. Una vez se ha ejecutado esto, puedes acceder a la URL que se ha indicado en el apartado "host" del _.yaml_.
. Se hace _login_ vía _token_. Este se obtiene mediante la ejecución de este comando:
+
[source,bash]
----
kubectl get secret -n keos-core vault-unseal-keys -o jsonpath="{.data.vault-root}" | base64 -d
----

IMPORTANT: En el repositorio de conectores se tendrá disponible el artefacto `sscc-mongodb-0.3_2.12-1.3.x.jar`, que es el que se usa en este caso concreto, en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>`.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento para MongoDB desde _Stratio Command Center_ debes ir a 'Deploy a Service' -> 'Connectors NoSQL' y seleccionar el agente "MongoDB Agent".

En la instalación del agente para MongoDB se debe añadir la información correspondiente al MongoDB que se quiere descubrir. Además, se debe añadir la URL del repositorio de conectores donde se almacene el artefacto `sscc-mongodb-0.3_2.12-1.3.x.jar` y subir las credenciales de acceso a _Stratio KMS_.

Para la subida de las credenciales debes acceder a `https://<stratio_kms_ui_url>/ui/vault/secrets` y, en el directorio `userland/passwords/<nombre_agente>`, crear un secreto con las siguientes claves:

* _user_: <nombre_usuario_mongodb>
* _password_: <contraseña_usuario_mongodb>
+
image::ejemplo-vault.png[]

En el ejemplo, la instalación del agente queda de esta manera:

* _Root discovery path_: /sample_mflix
* _Custom Service URL_: mongodb://dbsqa.labs.stratio.com:27017
* _Access credentials_: mongo-agent
* _DataStore driver location_: http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar

Una vez tienes desplegado el agente de descubrimiento, en _Stratio Data Governance_ aparecerá lo siguiente:

image::ejemplo-descubrimiento-mongo.png[]

== Virtualiza tus datos

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de MongoDB. Para ello, basta con añadir la URL del repositorio de conectores del artefacto `sscc-mongodb-0.3_2.12-1.3.x.jar` en la variable `Additional jars`.

En el ejemplo que se está siguiendo, el agente de Eureka queda de esta manera:

* _Additional jars_: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar`.

NOTE: Recuerda que si ya tienes más de un artefacto en la lista se deben añadir los siguientes separándolos por una coma.

=== _Stratio Virtualizer_

Para el uso de _Stratio Virtualizer_ es necesario tener configurado el conector de MongoDB. Para ello se debe añadir la URL del artefacto `sscc-mongodb-0.3_2.12-1.3.x.jar` en la variable `JDBC Drivers URL List` y además subir las credenciales de acceso a _Stratio KMS_.

Para la subida de las credenciales se debe acceder a https://<stratio_kms_ui_url>/ui/vault/secrets y, en el directorio `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>`, crear un secreto con las siguientes claves:

* _user_: <nombre_usuario_mongodb>
* _password_: <contraseña_usuario_mongodb>

En el ejemplo que se está siguiendo queda de esta manera:

* _JDBC Drivers URL List_: *http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar*.

Para realizar la virtualización de MongoDB debes añadir tablas técnicas incluidas en una colección de _Stratio Data Governance_ y dar permisos sobre las mismas en _Stratio GoSec_ al usuario adecuado.

Una vez hecho eso, los datos son accesibles en el resto de módulos de _Stratio Generative AI Data Fabric_. Puedes ver cómo aparecen en la siguiente imagen:

image::ejemplo-coleccion-mongo.png[]

image::ejemplo-coleccion-rocket-mongo.png[]

== Transforma tus datos

=== _Stratio Rocket_

Para el uso de _Stratio Rocket_ es necesario tener el conector de MongoDB configurado. Para ello, debes añadir la URL del artefacto `sscc-mongodb-0.3_2.12-1.3.x` en la variable 'Customized deployment' -> 'Settings' -> 'Classpath' -> _Rocket extra jars_ y además subir las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_.

* 'Customized deployment' -> 'Settings' -> 'Classpath' -> _Rocket extra jars_: http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar

* Para la subida de las credenciales usadas en _Stratio Rocket_, accede a `https:<stratio_kms_ui_url>/ui/vault/secrets` y, en el directorio `userland/passwords/<nombre++_++rocket>.<namespace++_++rocket>`, crea un secreto con las siguientes claves:
** _user_: <nombre_usuario_mongodb>
** _password_: <contraseña_usuario_mongodb>

* Para la subida de las credenciales usadas en _Workflows_ de _Stratio Rocket_, accede a `https:<stratio_kms_ui_url>/ui/vault/secrets` y, en el directorio `userland/passwords/execution-identity-<nombre++_++rocket>.<namespace++_++rocket>`, crea un secreto con las siguientes claves:
** _user_: <nombre_usuario_mongodb>
** _password_: <contraseña_usuario_mongodb>

En _Stratio Rocket_ se puede acceder a la colección virtualizada de MongoDB mediante consultas SQL directamente o mediante un _workflow_. En las siguientes imágenes hay un ejemplo de ambas:

image::ejemplo-querie-coleccion-rocket-mongo.png[]

image::ejemplo-workflow-coleccion-rocket-mongo.png[]

TIP: Puedes consultar más información sobre el resto de parámetros de configuración en la xref:mongodb:operations-guide.adoc#rocket-configuration[guía de operaciones].

=== _Stratio Intelligence_

Previo a la integración con el conector es necesario configurar _Stratio Intelligence_. Para ello debes añadir las siguientes propiedades como variables personalizadas:

* `INTERPOLATED_ANALYTIC_ENV_CROSSDATA_CATALOG_SECRET_INSTANCE_NAME`: ${username}
* `ANALYTIC_ENV_VAULT_PATH`: "people".
* `ANALYTIC_ENV_REQUESTS_CA_BUNDLE`: /opt/sds/stratio_analytic/security/ca-bundle.pem
* `ANALYTIC_ENV_HIDE_VAULT_TOKEN`: false

image::intelligence-variables-comunes.png[]

Además, en el entorno multiusuario es necesario tener activada la opción "Allow artifact deployment" y tener en la ruta el valor _artifacts_ como se muestra en la siguiente imagen:

image::ejemplo-multiuser.png[]

Una vez tengas _Stratio Intelligence_ configurado, tienes que añadir el conector de MongoDB al directorio _artifacts/spark++_++jars_ y subir las credenciales a _Stratio KMS_.

Para la subida del artefacto, se debe descargar desde *http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar* en el directorio _artifacts/spark++_++jars_ dentro del _workspace_ de _Stratio Intelligence_ realizando una petición cURL. En el caso que se está tratando, se debería realizar la siguiente petición:

[source,bash]
----
curl http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mongodb-0.3_2.12-1.3.x.jar --output mongo_connector_0.3_2.12-1.2.x.jar
----

En la siguiente imagen se ve cómo queda almacenado en el directorio.

image::ejemplo-almacenaje-artefacto.png[]

Para la subida de las credenciales, se debe acceder a https://<stratio_kms_ui_url>/ui/vault/secrets y, en el directorio `/people/passwords/<nombre_usuario_intelligence>`, crear un secreto con las siguientes claves:

* _user_: <nombre_usuario_mongodb>
* _password_: <password_usuario_mongodb>

Una vez tengas esto configurado, ve en el ejemplo cómo se puede acceder a las tablas que se han virtualizado de la base de datos MongoDBB externa.

image::ejemplo-acceso-intelligence-mongo.png[]
