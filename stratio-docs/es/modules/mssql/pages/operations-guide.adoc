= Guía de operaciones

== Descripción

El conector SSCC Microsoft SQL Server te permite la integración de Microsoft SQL Server en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:mssql:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

El conector soporta dos modos de autenticación:




* Usuario/contraseña.
* https://kerberos.org/[Kerberos].

Como se verá más adelante, según el modo elegido habrá que usar unos valores de configuración y credenciales específicas en cada uno de los servicios de _Stratio Generative AI Data Fabric_.

== Prerrequisitos

. Instalar el xref:connectors-repository:operations-guide.adoc#_instalación[repositorio de conectores].
+
IMPORTANT: En el repositorio de conectores se tendrá disponible en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>` el artefacto `sscc-mssql-0.3_2.12-1.5.x`, que se utiliza para un uso básico del conector de Microsoft Server SQL. Es necesario subir el artefacto _driver JDBC_ que se indica en la matriz de compatibilidad al repositorio de conectores. Este _driver_ no se disponibiliza.

. Tener accesible la interfaz de usuario de _Stratio KMS_ para la gestión de credenciales:
+
Visita la sección de la xref:ROOT:quick-start-guide.adoc[guía de inicio rápido general] para consultar los pasos necesarios para tenerla disponible.

. Tener una instancia de una base de datos de Microsoft SQL Server accesible desde _Stratio Generative AI Data Fabric_ con el modo de autenticación elegido configurado:
+
** Para la autenticación básica, hará falta un usuario con los permisos adecuados y su contraseña.
** Para configurar la autenticación con https://web.mit.edu/kerberos/kfw-4.1/kfw-4.1/kfw-4.1-help/html/kerberos_terminology.htm[Kerberos] en los servicios de la plataforma, necesitarás:
*** El nombre del https://web.mit.edu/kerberos/krb5-1.5/krb5-1.5.4/doc/krb5-user/What-is-a-Kerberos-Principal_003f.html[*_service principal_*] y su *_realm_* asociado.
*** La contraseña de Kerberos.
*** El SPN del servidor de Kerberos.

. Crear los secretos en _Stratio KMS_. Para ello debes acceder a `https://<stratio_kms_ui_url>/ui/vault/secrets` y crear un secreto en la carpeta correspondiente del servicio con las siguientes opciones según el modo de autenticación:
+
--
** Usuario/contraseña
*** *_user_*: `<microsoft_sql_server_user>`.
*** *_pass_*: `<microsoft_sql_server_password>`.

** Kerberos
*** *_principal_*: `<microsoft_sql_server_service_principal_name>`.
*** *_pass_*: `<kerberos_pass>`.
*** *_spn_*: (SPN del servidor de Kerberos). Debe tener el siguiente formato: `MSSQLSvc/<FQDN>:<puerto>@<REALM>`, siendo FQDN el nombre de dominio completo del servidor.
+
--

Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:

** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>.<namespace_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.
+
NOTE: El nombre y los valores del secreto para todos los servicios deben coincidir con los elegidos para configurar el agente de descubrimiento.

. Modificar la configuración de Kerberos en los servicios.
+
Para la autenticación con Kerberos es necesario modificar el fichero de configuración usado en el servicio desde el que se va a iniciar la autenticación, incluyendo en él la información propia del Kerberos usado en Microsoft SQL Server.

Para modificarlo, debes conseguir el nombre del _ConfigMap_ de Kerberos, que se puede encontrar en '_Stratio Command Center_' -> 'Services' -> '<nombre_agente>' -> '_Configuration_' -> '*_Kerberos configmap name_*'.

image::mssql-cct-configmap.png[]

Una vez conseguido el nombre del _ConfigMap_, puedes editarlo con una herramienta de gestión del _cluster_ de Kubernetes, por ejemplo _kubectl_:

[source,bash]
----
kubectl edit configmap <configmap_name>
----

El fichero ya contiene información previa, propia del servicio, a la que se debe añadir la configuración de Kerberos para acceder a Microsoft SQL Server.

Si tienes por ejemplo la siguiente configuración de acceso con Kerberos a Microsoft SQL Server:

. *_Service Principal_*: `connectors/stratio.com@MSSQL.GENERAL.COM`.
. *_Realm_*: `MSSQL.MYCOMPANY.COM`.
. *_KDC host_*: `mssql.mycompany.com:88`.

Y el fichero https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html[_krb5.conf_] del _ConfigMap_ con la configuración de Kerberos previa del servicio es:

[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
 ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
 }
----

Modificándolo para aceptar la configuración de Microsoft SQL Server, quedaría de la siguiente manera:

[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
  ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
  }
  MYCOMPANY.COM={
   kdc=mssql.mycompany.com:88
   admin_server = mssql.mycompany.com:749
  }
[domain_realm]
 .mycompany.com = MSSQL.MYCOMPANY.COM
 mycompany.com = MSSQL.MYCOMPANY.COM
----

NOTE: Es necesario reiniciar el servicio tras modificar esta configuración para que tenga efecto.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento de _Stratio Data Governance_ para Microsoft SQL Server debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS' el agente "Microsoft SQLServer Agent".

Los campos a rellenar para la instalación son:

* *_General_*:
** *_Service ID_*: identificador único del agente. Ejemplo: _dg-mssql-agent_.
** *_Service name_*: nombre mostrado en _Stratio KEOS_. Ejemplo: _dg-mssql-agent_.
* *_Metadata Datastore (PostgreSQL®)_*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
* *Configuration of the Service to be Discovered*
** *_Service to be discovered_:*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Es el que se mostrará en su interfaz de usuario. Ejemplo: _dg-mssql-agent_.
*** *_Root discovery path_*: esquemas de Microsoft SQL Server que quieras que sean descubiertos. Deben estar separados por comas, sin espacios y con una barra `/` al principio.
+
image::mssql-cct-deployment.png[]

** *_Resource datastore connection configuration_*
*** *_Custom Service URL_*: URL JDBC usada para conectarse a Microsoft SQL Server. Ejemplo: `jdbc:sqlserver://mssql.stratio.com:1434/-db-`.
*** *_Mssql Native Mode_*: los posibles valores son "True" y "False", "True" si el usuario quiere virtualizar con el conector nativo de _Stratio Virtualizer_ y "False" si quiere virtualizar sin modo nativo.
*** *_Custom data store service security_*: tipo de autenticación usado para la conexión: MD5 (usuario/contraseña) o KRB (Kerberos).
*** *_Access credentials_*: nombre del secreto creado en xref:#create-secret[_Stratio KMS_]. Ejemplo: _mssql-secret_.
*** *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del conector SSCC Microsoft SQL Server. Ejemplo: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
*** *_JDBC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del _driver JDBC_ elegido. Ejemplo: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar`.
+
image::mssql-cct-deployment2.png[]
+
*** *_Enable optimization engine_*: activa/desactiva la optimización automática del almacén de datos de Microsoft SQL Server.
**** *_Granularity Optimizer Level_*: se define el nivel de granularidad/profundidad de la optimización. Los valores posibles son "1" y "2":
***** *Nivel 1*: la optimización se realiza utilizando únicamente metadatos y estadísticas del almacén de datos. Por defecto está en este nivel.
***** *Nivel 2*: además de los análisis del nivel 1, realiza un análisis en mayor profundidad de la distribución de los datos de las tablas mediante técnicas de inferencia y muestreo.
+
IMPORTANT: Para el *nivel 2* es necesario tener permisos de acceso al dato en las tablas que se deseen optimizar. Este nivel puede enlentecer el proceso de descubrimiento.
+
**** *_Force create statistics_*: activa/desactiva la creación forzada de las estadísticas requeridas para la optimización. Por defecto está desactivado, asumiendo que las estadísticas ya están creadas.
+
NOTE: Se recomienda que el administrador de la base de datos genere previamente las estadisticas desde el almacén de datos de Microsoft SQL Server para aquellas tablas que se deseen optimizar.
+
**** *_Sampling Percent_*: porcentaje de muestreo para la optimización de nivel "2". Esta variable sólo aparece cuando se elige el _Granularity optimization engine_ con valor "2".
+
El valor es el porcentaje en tanto por 1. Por defecto, está en "0.65", que corresponde a un muestreo del 65%.
+
**** *_Optimizer Parallelism Level_*: número de hilos que se usarán para la optimización.
+
image::mssql-optimizer-sscc-conf-operations.png[]
+
NOTE: En la variable *General* -> *Configuration of the Service to be Discovered* -> *Filter discovered resources* -> *Skipped resource paths regular expression (databases)* se recomienda introducir el valor `(.\*sys.*)|(.\*INFORMATION_SCHEMA.*)` para evitar que aparezcan las tablas del sistema.

El proceso de descubrimiento es asíncrono, una vez terminado el descubrimiento se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::mssql-discover-metadata.png[]

=== Modos _legacy_ y _path_

Existen dos modos de descubrimiento:

* _Legacy_

Selecciona el campo _Use legacy mode_ con el valor "true" para activar el modo _legacy_.

image::mssql-mode-legacy-conf.png[]

* _Path_

Selecciona el campo _Use legacy mode_ con el valor "false" para activar el modo _path_.

image::mssql-mode-sscc-conf.png[]

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de Microsoft SQL Server. Para ello basta con añadir la URL del repositorio de conectores del artefacto `sscc-mssql-0.3_2.12-1.5.x` en la variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

image::mssql-bdl.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

TIP: Consulta aquí xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[más información acerca del procesamiento de datos con BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ soporta la interacción con Microsoft SQL Server a través del conector SSCC Microsoft SQL Server. Esta integración tiene ciertos requisitos:

* Se deben modificar los siguientes campos del despliegue de _Stratio Virtualizer_ en _Stratio Command Center_. Además de las URL del artefacto `sscc-mssql-0.3_2.12-1.5.x`, se necesita agregar la del _driver_ *_jre8_*:
+
--
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *JDBC Integration*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
--
+
image::mssql-virtualizer.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener el conector de Microsoft SQL Server configurado. Para ello:

* Se debe añadir la URL del artefacto `sscc-mssql-0.3_2.12-1.5.x.jar` en la variable 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` de _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
+
image::mssql-rocket.png[]

* Además, debes subir las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_.

IMPORTANT: Cuando se esté usando el *modo _legacy_*, se debe añadir en los _workflows_ la variable `lineageMode` a "legacy" para que funcionen correctamente las funcionalidades antiguas: reglas de calidad y linaje.

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `com.microsoft.sqlserver.jdbc.SQLServerDriver:com.stratio.connectors.ssccmssql.MssqlQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_url_jdbc_mssql>.port.<port_url_jdbc_mssql>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccmssql.MssqlDriverMD5:com.stratio.connectors.ssccmssql.MssqlQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que si tienes más de una referencia ya en la lista, estas se deben añadir separándolas por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la correcta configuración de _Stratio Intelligence_ con el conector de Microsoft SQL Server se recomienda ver la xref:mssql:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_ en la guía de inicio rápido], recordando que hay que usar el formato adecuado al modo de autenticación para los secretos.
