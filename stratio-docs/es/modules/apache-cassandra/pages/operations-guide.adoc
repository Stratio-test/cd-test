= Guía de operaciones

== Descripción

El conector SSCC Apache Cassandra® te permite la integración de Apache Cassandra® en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:apache-cassandra:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

Actualmente, el conector sólo soporta autenticación con *usuario y contraseña*.

== Prerrequisitos

* Instalar el xref:connectors-repository:operations-guide.adoc#_instalación[repositorio de conectores].
+
IMPORTANT: En el repositorio de conectores se tendrá disponible en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>` el artefacto `sscc-cassandra-0.3_2.12-1.3.x, que se utiliza para un uso básico del conector SSCC Apache Cassandra®.

* Tener accesible la xref:ROOT:quick-start-guide.adoc[interfaz de usuario de _Stratio KMS_].
* Tener una instancia de una base de datos Apache Cassandra® instalada y accesible desde _Stratio Generative AI Data Fabric_.
* Tener un usuario a la base de datos Apache Cassandra® instalada con los siguientes permisos básicos:
** Privilegios
- CREATE
- DESCRIBE
- SELECT
- MODIFY
- ALTER
** Nombre del recurso(s)
- KEYSPACE `<keyspace-name>`. Nombre del _keyspace_ o _keyspaces_ que se pretenden descubrir.
- TABLE `<table-name>`. Nombre de la tabla o tablas que se pretenden descubrir.

* Crear los secretos en _Stratio KMS_. Actualmente, el conector solo admite autenticación con usuario y contraseña.
+
--
El secreto que se va a subir consta de dos claves:

* _user_ : `<cassandra_user>`.
* _pass_ : `<cassandra_password>`.
--
+
Habrá una imagen similar a esta:
+
image::cassandra-vault-discovery-agent-user-pass.png[]
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:
+
** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento de _Stratio Data Governance_ para Apache Cassandra® debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS'* el agente "Apache Cassandra Agent".

Los campos a rellenar para la instalación son:

* *_General_*:
** *_Service ID_*: identificador único del agente. Ejemplo: _/dg-agent-cassandra-prueba_.
** *_Name of the Service_*: nombre mostrado en _Stratio KEOS_. Ejemplo: _dg-agent-cassandra-prueba_.
* *_Metadata Data store (PostgreSQL®)_*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Es el que se mostrará en su interfaz de usuario. Ejemplo: _dg-agent-cassandra-prueba_.
*** *_Root discovery path_*: esquema sobre el que se quieren descubrir los metadatos de forma recursiva. En el caso de Apache Cassandra®, son los distintos _keyspaces_ que se quieran gobernar. Ejemplo: _/exampleconnector,/example2connector_.
** *_Resource data store connection configuration_*
*** *_Custom Service URL_*: URL donde está alojada la instancia de Apache Cassandra®. Ejemplo: _dbsqa.labs.stratio.com:9043_.
*** *_Custom data store service security_*: método de autenticación para la instancia de Apache Cassandra®. Ejemplo: MD5.
*** *_Access credentials_*: nombre del _stratiocredentials_ o ruta de _Stratio KMS_ con las credenciales de autorización. Ejemplo: _cassandra-secrets_.
* *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del conector SSCC Apache Cassandra®. Ejemplo: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-cassandra-0.3_2.12-1.3.x.jar`.

Debería quedar una configuración similar a la de la siguiente imagen:

image::cassandra-discovery-agent-settings.png[width=80%]

El proceso de descubrimiento es asíncrono, una vez terminado el descubrimiento se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::cassandra-governance-descubrimiento.png[]

image::cassandra-governance-tabla.png[]

NOTE: Las vistas en Apache Cassandra® están soportadas pero se muestran como tablas en la interfaz de usuario de _Stratio Data Governance_.

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector SSCC Apache Cassandra®. Para ello basta con añadir la URL del repositorio de conectores del artefacto `sscc-cassandra-0.3_2.12-1.3.x` en la variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

Debería quedar una configuración similar a esta:

* _Additional jars_: *http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-cassandra-0.3_2.12-1.3.x.jar*

Tal como aparece en siguiente imagen:

image::cassandra-eureka-environment.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

TIP: Consulta aquí xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[más información acerca del procesamiento de datos con BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ soporta la interacción con Apache Cassandra® a través del conector SSCC Apache Cassandra®. Esta integración tiene ciertos requisitos:

* Se deben modificar los siguientes campos del despliegue de _Stratio Virtualizer_ en _Stratio Command Center_:
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-cassandra-0.3_2.12-1.1.0.jar`.

Debería quedar una configuración similar a la de la siguiente imagen:

image::cassandra-virtualizer-environment.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener el conector SSCC Apache Cassandra® configurado. Para ello:

* Se debe añadir la URL del artefacto `sscc-cassandra-0.3_2.12-1.3.x` en la variable 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` de _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-cassandra-0.3_2.12-1.1.0.jar`.

Tal como aparece en siguiente imagen:

image::cassandra-rocket-environment.png[]

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using Spark format_: `com.stratio.connectors.apache-cassandra:com.stratio.connectors.sscccassandra.CassandraQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_url_cassandra>.port.<port_url_cassandra>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.sscccassandra.CassandraDriverMD5:com.stratio.connectors.sscccassandra.CassandraQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de una referencia en la lista, se deben añadir las siguientes separándolas por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje ni las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la configuración correcta de _Stratio Intelligence_ consulta la xref:apache-cassandra:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_]. Para la integración con Apache Cassandra®, sólo es necesaria la subida de credenciales mostrada en los prerrequisitos.
