= Guía de usuario

== Descripción

El conector SSCC Databricks te permite la integración completa de Databricks en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:databricks:compatibility-matrix.adoc[matriz de compatibilidad].

== Descubre tus datos

=== Conoce tus datos

El descubrimiento realizado por el agente SSCC Databricks hará visible y navegable en _Stratio Data Governance_ la jerarquía de datos en Databricks:

* Catálogos
* Tablas (prefijadas con su esquema)
* Columnas

image::databricks-governance-datastore.png[]

TIP: Puedes leer más acerca del uso del almacén de datos en la xref:stratio-data-governance:user-manual:from-a-data-store-to-a-dictionary.adoc[Guía de usuario de _Stratio Data Governance_].

El agente también asociará metadatos técnicos o de sistema a los niveles de la jerarquía de datos:

. *_Almacén de datos_*, accesible a través del botón "System attributes".
** Generales
+
--
*** _Version_: versión del conector que realizó el descubrimiento.
*** _URL_: URL JDBC usada para la conexión con Databricks.
*** _Security_: tipo de seguridad utilizado. Sus posibles valores son PAT (_Personal Access Token_) o OAuth2.
--
+
image::databricks-governance-datastore-system-attrs.png[]
+
** Atributos del origen de datos: nombre y versión de la base de datos y nombre, versión y clase del _driver JDBC_ utilizado.
+
image::databricks-governance-datastore-system-attrs2.png[]

. *_Tabla_*, accesible a través del botón "System attributes" o del enlace "Connector attributes".
** _database_: catálogo donde está incluida la tabla.
** _schema_: esquema donde está incluida la tabla.
** _table_: nombre de la tabla.
** _format_: formato del fichero. Posibles valores: "delta" y el resto de formatos soportados por Databricks y el conector.
** _location_: localización del fichero en Databricks.
** _tableType_: tipo de tabla. Posibles valores: "TABLE" y "VIEW".
** _delta.minReaderVersion_: version mínima soportada del protocolo de lectura.
** _delta.minWriterVersion_: version mínima soportada del protocolo de escritura.
+
image::databricks-governance-table-system-attrs.png[]

. *_Columna_*, accesible a través del botón "System attributes" o del enlace "Connector attributes" tras seleccionarla en la lista.
** Propiedades (solo en _System attributes_): precisión, escala y si el tipo tiene signo.
** Atributos del conector: tipo de almacén de datos (_DATABRICKS_) y nombre del tipo de datos original en Databricks.
+
image::databricks-governance-column-system-attrs.png[]

=== Virtualización de la BDL

El conector soporta la personalización del acceso al dato en las tablas virtualizadas mediante xref:stratio-data-governance:user-manual:bdl-virtualization.adoc#_atributos_personalizados_de_bdl[atributos avanzados de BDL] de _Stratio Data Governance_, modificables desde la interfaz de usuario:

* *bdl.options.virtualizer.native*: los posibles valores son "True" y "False". "True" si el usuario quiere acceder al dato con el xref:stratio-virtualizer:user-guide:what-can-i-do-with-stratio-virtualizer.adoc#_consultas_nativas[dialecto nativo] de _Stratio Virtualizer_. Si se configura este atributo, se sobrescribirá la configuración por defecto ("True").
* *bdl.options.native.filter*: filtro aplicado sobre la virtualización de la tabla en caso de que el modo de acceso al dato sea con el dialecto nativo de _Stratio Virtualizer_.

NOTE: Puedes consultar cómo crear atributos en la xref:stratio-data-governance:user-manual:addition-of-metadata[guía de usuario] de _Stratio Data Governance_.

TIP: Para más detalles del uso de la BDL consulta la xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[documentación de procesamiento de datos con BDL].

== Virtualiza tus datos

Una vez descubiertas las tablas, es posible añadirlas a una vista técnica de una colección. Todos los parámetros configurables del descubrimiento y los modificados desde la interfaz de usuario de _Stratio Data Governance_ se propagan en las colecciones donde se añada esa tabla.

TIP: Para saber más sobre cómo gestionar las colecciones puedes consultar xref:stratio-data-governance:user-manual:collections.adoc[la guía de usuario de _Stratio Data Governance_].

IMPORTANT: Ten en cuenta que, para virtualizar las tablas descubiertas, es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

Para crear una tabla directamente en el catálogo de _Stratio Virtualizer_ puedes ejecutar las siguientes sentencias:

* Si quieres crear la tabla con el modo nativo:

[source,sql]
----
CREATE TABLE databricks_table USING com.stratio.crossdata.connector.databricks options (
  'url' 'jdbc:databricks://<Server_Hostname>:443/<database>;httpPath=<Http Path>',
  'stratiosecurity' 'true',
  'stratiosecuritymode' 'custom_sscc',
  'stratiocredentials' '<nombre_secreto>',
  'stratiossccdriver' 'com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT',
  'dbtable' '<nombre_tabla>'
)
----

* Si quieres crear la tabla sin el modo nativo:

[source,sql]
----
CREATE TABLE databricks_table USING jdbc options (
  'url' 'jdbc:databricks://<Server_Hostname>:443/<database>;httpPath=<Http Path>',
  'stratiosecurity' 'true',
  'stratiosecuritymode' 'custom_sscc',
  'stratiocredentials' '<nombre_secreto>',
  'stratiossccdriver' 'com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT',
  'dbtable' '<nombre_tabla>'
)
----

Para usar autenticación OAuth2 en lugar de _Personal Access Token_ (PAT), reemplaza `com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT` con `com.stratio.connectors.ssccdatabricks.DatabricksDriverOAuth2`.

NOTE: Recuerda que tienes que usar un secreto diferente para OAuth2.

== Transforma tus datos

=== _Stratio Rocket_

Una vez virtualizados los datos, es posible acceder desde _Stratio Rocket_ mediante:

* El catálogo.
+
image::databricks-rocket-catalog.png[]

* Dentro de los _workflows_, haciendo uso del _input_ de xref:stratio-rocket:user-guide:workflow-asset/data-inputs.adoc#_stratio_virtualizer[_Stratio Virtualizer_]. Es posible forzar el acceso mediante el dialecto nativo marcando la casilla "Force query execution with native connectors".
+
image::databricks-rocket_virtualizer_input.png[]
+
A la hora de configurar un _workflow_ de _Stratio Rocket_ usando una caja de tipo _jdbc_, deberás rellenar las siguientes propiedades opcionales (autenticación con OAuth2):

* _oauth2.client.id_: `<oauth2.endpoint_id_databricks>`.
* _oauth2.endpoint_: `<oauth2.endpoint_databricks>`.
* _oauth2.client.secret_: `<oauth2.client.secret_databricks>`.
* _keytab_: `mock1`.
* _principal_: `mock2`.

=== _Stratio Intelligence_

Se puede comprobar cómo se accede a los datos desde _Stratio Intelligence_ en la xref:ROOT:quick-start-guide.adoc#_stratio_intelligence[guía de inicio rápido].
