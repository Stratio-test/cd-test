= Guía de operaciones

== Descripción

El conector SSCC Databricks te permite la integración completa de un espacio de trabajo de https://www.databricks.com/product/databricks-sql[Databricks] en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:databricks:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

El conector soporta dos modos de autenticación:

* _Personal Access Token_ (PAT).
* Oauth2 _token_ para el proveedor Microsoft Azure.

Como se verá más adelante, según el modo elegido habrá que usar unos valores de configuración y credenciales específicos en cada uno de los servicios de la plataforma.

== Prerrequisitos

. Tener un espacio de trabajo de Databricks instalado y accesible desde _Stratio Generative AI Data Fabric_.
+
En los ejemplos de la guía se asumirá que el espacio de trabajo incluye el catálogo de ejemplos https://docs.databricks.com/dbfs/databricks-datasets.html#sample-datasets[provisto por Databricks]: _NYC Taxi Trip Analysis_.
+
. Tener una URL JDBC para la conexión con el espacio de trabajo de Databricks.
+
Consulta cómo conseguirla en https://docs.databricks.com/integrations/jdbc-odbc-bi.html#retrieve-the-connection-details[la documentación oficial de Databricks].
+
En los ejemplos se usa la URL JDBC ficticia de un espacio de trabajo _jdbc:databricks://adb-1234567890123456.7.azuredatabricks.net/-db-;httpPath=/sql/1.0/endpoints/abcdef1234567890_.
+
. Tener los datos necesarios para la autenticación según el modo escogido:

** _Personal Access Token_: consulta cómo generar el _token_ en https://docs.databricks.com/administration-guide/access-control/tokens.html[la documentación oficial de Databricks].
** OAuth2 con Microsoft Azure: necesitarás los siguientes datos:
+
--
*** La URL inicial de autenticación, típicamente `https://login.microsoftonline.com/<directory-id>`.
*** _Service Principal_ (o _Application_) id.
*** El valor del secreto del _Service Principal_.
--
+
TIP: Puedes leer más acerca de este tipo de autenticación en https://learn.microsoft.com/en-us/azure/databricks/dev-tools/api/latest/aad/service-prin-aad-token#--provision-a-service-principal-in-azure-portal[la documentación oficial de Databricks en Microsoft Azure].
+
. Instalar el repositorio de conectores.
+
Visita la sección de la xref:connectors-repository:operations-guide.adoc#_instalación[Guía de operaciones] para averiguar cómo instalarlo.
+
NOTE: En el repositorio de conectores se tendrán disponibles en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>` los artefactos usados en esta guía: `sscc-hive-0.3_2.12-1.5.x.jar`.y `hive-jdbc-3.1.2-1.0.0-47b3295.jar`.
+
. Tener accesible la interfaz de usuario de _Stratio KMS_ para la gestión de credenciales:
+
Visita la sección de la xref:ROOT:quick-start-guide.adoc#access-kms-ui[Guía rápida general] para consultar los pasos necesarios para tenerla disponible.
+
. Crear los secretos en _Stratio KMS_. Para ello debes acceder a `https://<stratio_kms_ui_url>/ui/vault/secrets` y crear un secreto en la carpeta correspondiente del servicio con las siguientes opciones según el modo de autenticación:
+
--
** _Personal Access Token_
*** *_token_*: `<personal_access_token>`.
+
image::databricks-pat-vault.png[]
+
** OAuth2 con Microsoft Azure
*** *_oauth2.client.id_*: `<client_id>`.
*** *_oauth2.client.secret_*: `<client_secret_value>`.
*** *_oauth2.endpoint_*: `<endpoint>`.
+
image::databricks-oauth2-vault.png[]
+
--
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:

** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>.<namespace_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.
+
NOTE: El nombre y los valores del secreto para todos los servicios deben coincidir con los elegidos para configurar el agente de descubrimiento.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento de _Stratio Data Governance_ para Databricks debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors Data Warehouse' el agente `Databricks Agent`.

Los campos a rellenar para la instalación son:

* *_General_*
** *_Service ID_*: identificador único del agente. Ejemplo: _dg-databricks-agent_.
** *_Service name_*: nombre mostrado en _Stratio KEOS_. Ejemplo: _dg-databricks-agent_.
* *_Metadata Datastore (PostgreSQL®)_*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
* *_Configuration of the Service to be Discovered_*
** *_Service to be discovered_:*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Es el que se mostrará en su interfaz de usuario. Ejemplo: _dg-databricks-agent_.
*** *_Root discovery path_*: rutas de los catálogos de Databricks que se quieren descubrir. Ejemplo: _/samples,/hive_metastore_. Puedes usar `/` para descubrir todos los catálogos a los que se tenga acceso.
* *_Resource datastore connection configuration_*
** *_Custom Service URL_*: URL JDBC usada para conectarse a Databricks. Ejemplo: `jdbc:databricks://adb-1234567890123456.7.azuredatabricks.net/-db-;httpPath=/sql/1.0/endpoints/abcdef1234567890`.
+
NOTE: La URL JDBC necesita tener como ruta la cadena *-db-*, que no debe ser modificada por el usuario. La cadena se sustituirá para cada uno de los catálogos informados en _Root discovery path_ en los metadatos apropiados.
+
** *_Custom data store service security_*: tipo de autenticación utilizada para la conexión: PAT (_Personal Access Token_) o OAuth2.
** *_Access credentials_*: nombre del secreto creado en xref:#create-secret[_Stratio KMS_]. Ejemplo: _databricks-secret_.
** *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del conector SSCC Databricks. Ejemplo: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.
** *_Databricks Native Mode_*: `(True/False)`. `True` si quieres virtualizar con el conector nativo de _Stratio Virtualizer_ y `False` si quieres virtualizar sin modo nativo.
+
image::databricks-cct-installation.png[]

A continuación, una vez terminado el proceso de descubrimiento, se podrá comprobar que se ha descubierto un nuevo almacén de datos en la interfaz de usuario de _Stratio Data Governance_.

image::databricks-governance-datastore.png[]

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Modos _legacy_ y _path_

Existen dos modos de descubrimiento:

* _Legacy_

image::databricks-mode-legacy-governance.png[]

Selecciona el campo _Use legacy mode_ con el valor "true" para activar el modo _legacy_.

image::databricks-mode-legacy-conf.png[]

* _Path_. Tiene 3 niveles: base de datos, esquema y tabla.

image::databricks-mode-sscc-governance.png[]

Selecciona el campo _Use legacy mode_ con el valor "false" para activar el modo _path_.

image::databricks-mode-sscc-conf.png[]

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de Databricks. Para ello hay que añadir la URL del artefacto necesario en la variable `Additional jars` en el descriptor del servicio en _Stratio Command Center_:

* 'Customized deployment' -> 'Settings' -> `Additional jars`: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.
+
image::eureka-bdl.png[]
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

=== _Stratio Virtualizer_

Para usar _Stratio Virtualizer_ es necesario tener configurado el conector de Databricks. Para ello, debes xref:create-secret[subir las credenciales de acceso a _Stratio KMS_] y añadir las URL de los artefactos necesarios en la variable `JDBC Drivers URL List` en el formulario de modificación del servicio _Stratio Virtualizer_ en _Stratio Command Center_:

* 'Customized deployment' -> 'Environment'
+
--
** *_JDBC Integration_*: habilitado.
** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.
--
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.
+
image::databricks-virtualizer.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener el conector de Databricks configurado. Para ello, debes xref:create-secret[subir las credenciales de acceso a _Stratio KMS_] para los _workflows_ y para _Stratio Rocket_ y añadir las URL de los artefactos necesarios en la variable `Rocket extra jars` en el formulario de modificación del servicio _Stratio Rocket_ en _Stratio Command Center_:

* 'Customized deployment' -> 'Settings' -> 'Classpath'
+
--
** *_Include Crossdata native connector library_*: habilitado.
** *_Include Crossdata native engine library_*: habilitado.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.
--
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.
+
image::databricks-rocket.png[]

IMPORTANT: Cuando se use el modo _legacy_ se debe añadir en los _workflows_ la variable `lineageMode` a "legacy" para que funcionen correctamente las funcionalidades antiguas: reglas de calidad y linaje.

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `com.databricks.client.jdbc.Driver:com.stratio.connectors.ssccdatabricks.DatabricksQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_url_jdbc_databricks>.port.<port_url_jdbc_databricks>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccdatabricks.DatabricksDriverOauth2:com.stratio.connectors.ssccdatabricks.DatabricksQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la configuración correcta de _Stratio Intelligence_ con el conector de Databricks consulta la xref:databricks:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_], recordando que hay que usar el formato adecuado al modo de autenticación para los secretos.
