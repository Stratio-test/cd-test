= Guía de operaciones

== Descripción

El conector SSCC BigQuery te permite la integración de BigQuery en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:bigquery:compatibility-matrix.adoc[matriz de compatibilidad].

== Prerrequisitos

. Instalar el xref:connectors-repository:operations-guide.adoc#_instalación[repositorio de conectores].
+
IMPORTANT: En el repositorio de conectores estará disponible en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>` el artefacto `sscc-bigquery-0.3_2.12-1.10.x`, que se utiliza para un uso básico del conector de BigQuery. Desde la versión 1.10.0, es necesario subir el artefacto _driver JDBC Simba_ que se indica en la matriz de compatibilidad al repositorio de conectores, ya que no se incluye por defecto en dicho repositorio.

. Tener accesible la xref:ROOT:quick-start-guide.adoc#Guía-Rápida[interfaz de usuario de _Stratio KMS_] para la gestión de credenciales.
. Disponer de Google Cloud Platform con BigQuery.
. Disponer de una cuenta de servicio de Google Cloud xref:https://developers.google.com/identity/protocols/oauth2/service-account[configurada] con los permisos mostrados a continuación:
* Es necesario asignar el rol `bigquery.metadataViewer` a la _service account_ del agente de descubrimiento de BigQuery. Este rol contiene los siguientes permisos:
** _bigquery.datasets.get_
** _bigquery.datasets.getIamPolicy_
** _bigquery.models.getMetadata_
** _bigquery.models.list_
** _bigquery.routines.get_
** _bigquery.routines.list_
** _bigquery.tables.get_
** _bigquery.tables.getIamPolicy_
** _bigquery.tables.list_
** _resourcemanager.projects.get_
** _resourcemanager.projects_

. Crear los secretos en _Stratio KMS_. Para conectar a un proyecto de BigQuery se usa el método de autorización de la cuenta del servicio de Google. Para ello, debes generar las credenciales de esta cuenta desde la consola de la API de Google. Una vez generadas, puedes descargarlas. Aquí tienes https://developers.google.com/identity/protocols/oauth2/service-account[más información acerca de la autenticación OAuth usando una cuenta de servicio].
+
--
El secreto que se va a subir consta de dos claves:
+
** _credentials_ : `<bigquery_token_base64_json>`, corresponde al JSON de la cuenta de servicio de BigQuery codificado en Base64.
** _parentProject_ : `<project_id_parent_project>`, corresponde al nombre del proyecto BigQuery al que deseas repercutir la facturación de los costes de acceso al dato.
--
+
Para realizar la codificación a Base64 del JSON de la cuenta de servicio se puede utilizar el comando:
+
[source,bash]
----
base64 BQService-account-key.json > base64GBQService-account-key.json
----
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:
+
** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento para BigQuery, debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors Data Warehouse' el agente "BigQueryAgent".

Los campos a rellenar para la instalación son:

* *_General_*:
** *_Service ID_*: identificador único del agente. Ejemplo: _dg-bigquery-agent_.
** *_Name of the Service_*: nombre mostrado en DC/OS.
* *_Metadata Data store_ (PostgreSQL®)*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ej: _poolpostgresgov_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Es el que se mostrará en su interfaz de usuario.
*** *_Root discovery path_*: ruta desde la que deseas descubrir los metadatos de forma recursiva siguiendo el patrón `/<projectId>/<dataset>/<table>`.
+
Ejemplos: _/myproject-111111_, _/myproject-111111/mydataset_, _/myproject-111111/mydataset/mytable_.
*** *_Google Cloud Storage temporary bucket_*: necesario para las operaciones de escritura de BigQuery.
+
image::bigquery-cct-deployment.png[]
+
** *_Resource data store connection configuration_*
*** *_Custom data store service security_*: sólo soporta `SERVICE_ACCOUNT`.
*** *_Access credentials_*: nombre del secreto creado en _Stratio KMS_. Ejemplo: _bigquery-connectors_.
*** *_BigQuery Native Mode_*: `(True/False)`. `True` si el usuario quiere virtualizar con el conector nativo de _Stratio Virtualizer_ y `False` si quiere virtualizar sin modo nativo.
+
image::bigquery-cct-deployment2.png[]
+
*** *_Data store driver location_*: URL donde se encuentra el JAR del conector SSCC BigQuery.
*** *_BigQuery connection attempts_*: define los reintentos de conexión con BigQuery.
*** *_Dataset page size_*: utilizado para la paginación de conjuntos de datos de BigQuery. Define el número de conjuntos de datos devueltos por página.
*** *_Table page size_*: utilizado para la paginación de conjuntos de datos de BigQuery. Define el número de tablas devueltas por página.
*** *_BigQuery concurrent connections_*: aumenta la velocidad de descubrimiento de grandes conjuntos de datos con tareas paralelas.
*** *_Enable connection through proxy_*: `(True/False)`. Habilitar conexión mediante proxy.
*** *_Proxy Address_*: si se ha habilitado la conexión mediante proxy, es necesario indicar el _host_ y el puerto del proxy con formato `host:port`.
*** *_Proxy authentication enabled_*: `(True/False)`. Si el proxy requiere autenticación. Si está a `True`, es necesario subir el secreto en la ruta del servicio con el nombre `bigquery-proxy-secret`.
+
image::bigquery-cct-deployment3.png[]

El proceso de descubrimiento es asíncrono, una vez terminado se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::bigquery-discover-metadata.png[]

NOTE: Las vistas en BigQuery están soportadas pero se muestran como tablas en la interfaz de usuario de _Stratio Data Governance_.

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de BigQuery. Para ello, basta con añadir la URL del repositorio de conectores del artefacto `sscc-bigquery-0.3_2.12-1.10.x` en la variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

image::bigquery-bdl.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

TIP: Consulta aquí xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[más información acerca del procesamiento de datos con BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ soporta la interacción con BigQuery a través del conector SSCC BigQuery. Esta integración tiene ciertos requisitos:

* Se deben modificar los siguientes campos del despliegue de _Stratio Virtualizer_ en _Stratio Command Center_:
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `True/False`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-bigquery-0.3_2.12-1.10.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/simba-jdbc-bigquery-42_1.3.3.1004-4.0.0-08702a9.jar`.
+
image::bigquery-virtualizer-conf.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener el conector de BigQuery configurado. Para ello:

. Se deben añadir las URL de los artefactos _sscc-bigquery-0.3_2.12-1.10.x_ y _simba-jdbc-bigquery-X.X.X_ en la variable 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` de _Stratio Command Center_.

* *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-bigquery-0.3_2.12-1.10.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/simba-jdbc-bigquery-X.X.X.jar`.
+
image::bigquery-rocket-conf.png[]

. Además, debes subir las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_.

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `com.simba.googlebigquery.jdbc.Driver:com.stratio.connectors.ssccbigquery.BigQueryQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `googleapis.com`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccbigquery.BigQueryDriver:com.stratio.connectors.ssccbigquery.BigQueryQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de una referencia en la lista, se deben añadir las siguientes separándolas por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la correcta configuración de _Stratio Intelligence_ consulta la xref:bigquery:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_]. Para la integración con BigQuery, solo es necesaria la subida de credenciales mostrada en los prerrequisitos.
