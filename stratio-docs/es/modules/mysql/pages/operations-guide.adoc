= Guía de operaciones

== Descripción

El conector SSCC MySQL te permite la integración de MySQL en _Stratio Generative AI Data Fabric_.

También permite la conexión con el almacén de datos MariaDB, el cual es un derivado de MySQL. Para conectarte a MariaDB puedes seguir esta guía, teniendo en cuenta que *el nombre indicado en la misma es MySQL*.

Las funcionalidades y versiones soportadas se encuentran en la xref:mysql:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

Actualmente, el conector sólo soporta la autenticación mediante usuario y contraseña.

== Prerrequisitos

. Instalar el xref:connectors-repository:operations-guide.adoc#_instalación[repositorio de conectores].
+
IMPORTANT: En el repositorio de conectores se tendrá disponible en la URL `http://connectors.tenant-my_namespace/v1/api/artifact/<nombre_artefacto>` el artefacto `sscc-mysql-0.3_2.12-3.1.x`, que se utiliza para un uso básico del conector de MySQL. Es necesario subir el artefacto _driver JDBC_ que se indica en la matriz de compatibilidad al repositorio de conectores, ya que este _driver_ no se incluye por defecto en dicho repositorio.

. Tener accesible la xref:ROOT:quick-start-guide.adoc[interfaz de usuario de _Stratio KMS_] para la gestión de credenciales.
. Tener una instancia de una base de datos de MySQL accesible desde _Stratio Generative AI Data Fabric_ con el modo de autenticación elegido configurado.
. Crear los secretos en _Stratio KMS_. Actualmente, el conector sólo admite la autenticación con usuario y contraseña.
+
--
El secreto que se va a subir consta de dos claves:

** _user_ : <mysql_user>.
** _pass_ : <mysql_pass>.
--
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:

** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento de _Stratio Data Governance_ para MySQL debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS'* el agente "MySQL Agent".

Los campos a rellenar para la instalación son:

* *_General_*
** *_Service ID_*: identificador único del agente.
** *_Name of the Service_*: nombre mostrado en DC/OS o K8s.
* *_Metadata Data store (PostgreSQL®)_*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ej: _poolpostgresgov_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Este nombre se mostrará en la interfaz de usuario de _Stratio Data Governance_.
*** *_Root discovery path_*: ruta desde la cual quieres descubrir los metadatos de forma recursiva.
+
image::mysql-cct-deployment1.png[]

** *Resource datastore connection configuration*
*** *_Custom Service URL_*: URL JDBC de la instancia de MySQL incluyendo el placeholder `-db-`. Por ejemplo: `jdbc:mysql://mysql.tenant-namespace:3306/-db-`.
*** *_Custom data store service security_*: sólo soporta usuario y contraseña (MD5).
*** *_Access credentials_*: nombre del secreto en Vault con las credenciales de autorización Eg: _mysql-connectors_.
*** *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de Conectores que contendrá el JAR del conector SSCC MySQL. Ejemplo: _http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mysql-0.3_2.12-3.1.x.jar_.
*** *_JDBC driver location_*: URL donde se encuentra el artefacto en el repositorio de Conectores que contendrá el JAR del _driver JDBC_ elegido. Ejemplo: _http://connectors.<tenant>-<namespace>/v1/api/artifact/mysql-jdbc-x.x.x.jar`_.
*** *_MySQL JDBC version_*: versión JDBC utilizada para conectarse a MySQL. Utiliza la 5.1.42 para MySQL server < 5.7 o la 8.0.30 para versiones más nuevas.
+
image::mysql-cct-deployment2.png[]

El proceso de descubrimiento es asíncrono. Una vez terminado, se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::mysql-discover-metadata.png[]

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de MySQL. Para ello, basta con añadir la URL del repositorio de conectores del artefacto `sscc-mysql-0.3_2.12-3.1.x` en la variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

image::mysql-bdl.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

TIP: Consulta aquí xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[más información acerca del procesamiento de datos con BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ soporta la interacción con MySQL a través del conector SSCC MySQL. Esta integración tiene ciertos requisitos:

* Se deben modificar los siguientes campos del despliegue de _Stratio Virtualizer_ en _Stratio Command Center_:
+
--
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mysql-0.3_2.12-3.1.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/mysql-jdbc-x.x.x.jar`.
--
+
image::mysql-virtualizer-conf.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener el conector de MySQL configurado. Para ello:

* Se debe añadir la URL del artefacto `sscc-mysql-0.3_2.12-3.1.x` y `mysql-jdbc-x.x.x` en la variable 'Customized deployment' -> 'Settings' -> 'Classpath' -> 'Rocket extra jars' de _Stratio Command Center_.

** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mysql-0.3_2.12-3.1.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/mysql-jdbc-x.x.x.jar`.
+
image::mysql-rocket-conf.png[]

* Además, debes subir las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_.

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `com.mysql8030.cj.jdbc.Driver:com.stratio.connectors.ssccmysql.MySqlDriverQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_url_jdbc_mysql>.port.<port_url_jdbc_mysql>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccmysql.MySqlDriver:com.stratio.connectors.ssccmysql.MySqlQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de una referencia en la lista, se deben añadir las siguientes separándolas por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la configuración correcta de _Stratio Intelligence_ consulta la xref:mysql:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_]. Para la integración con MySQL, solo es necesaria la subida de credenciales mostrada en los prerrequisitos.
