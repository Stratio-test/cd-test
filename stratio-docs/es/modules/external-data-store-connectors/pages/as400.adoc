= AS/400

Este documento explica cómo acceder al almacén de datos desde cada módulo de la plataforma.

Este almacén de datos no se puede desplegar en la plataforma de Stratio porque es necesario utilizar la infraestructura de IBM.

:note-caption: AVISO

NOTE: El _software_ de IBM tiene licencia comercial, por lo que es necesario el registro y la aceptación de los términos de la licencia.

== Matriz de soporte

|===
| Módulo | Versiones | AS/400

| _Stratio Spark_
| ≥ 2.4.4-3.4.2
| OK

| _Stratio Virtualizer_
| ≥ 2.23.1
| OK

| _Stratio Data Governance_
| ≥ 1.6.0
| OK

| _Stratio Rocket_
| ≥ 1.3.1
| OK

| _Stratio Sparta_
| -
| OK

| _Stratio Intelligence_
| -
| -

| _Stratio BDL_
| ≥ 1.6.0
| OK
|===

:note-caption: AVISO

[NOTE]
====
Se incluye soporte limitado de lectura desde _Stratio Spark_ 2.4.4-3.2.0, _Stratio Virtualizer_ 2.22.0 y _Stratio Rocket_ 1.0.0.

Los módulos sin versiones no han sido probados aún. Podrían estar soportados.
====

== _Stratio Spark_

=== Acceso al dato

Spark no tiene soporte oficial para el conector _AS/400 JDBC_, por lo que se ha desarrollado un nuevo Spark Dialect para añadirlo. Se incluye desde _Stratio Spark_ 2.4.4-3.4.2.

Se realizan algunas conversiones de tipo al escribir a la fuente de datos debido a la falta de coincidencia de tipos entre Spark y AS/400:

* _String_ → _CLOB_
* _Boolean_ → _CHAR(1)_
* _Short_ → _SMALLINT_

Si experimentas problemas al escribir nuevos datos, convierte los valores _boolean_ a _int_ antes de guardar (_true_ = 1, _false_ = 0).

=== Autorización/gestión de secretos

AS/400 soporta muchos métodos de autorización (usuario/contraseña, SSL, Kerberos... ). Actualmente, en _Stratio Spark_ solo se soporta la autorización usuario/contraseña.

Estas credenciales pueden almacenarse de forma segura en Vault y _Stratio Spark_ puede recuperarlas y usarlas para establecer la conexión.

_Stratio Spark_ permite configurar varias bases de datos de JDBC en el mismo _job_, cada una con sus propios secretos. Debes configurar una variable de entorno para cada base de datos:

[source,json]
----
"spark.mesos.driverEnv.SPARK_SECURITY_DB_<BD_NAME_UPPER_CASE>_VAULT_PATH"
----

Al hacer esto, Spark podrá descargar los secretos necesarios desde Vault y establecer las siguientes propiedades por ti:

[source,json]
----
"spark.db.<db_name_lower_case>.user",
"spark.db.<db_name_lower_case>.pass"
----

=== Guía de usuario

El _driver_ de AS/400 no está incluido en _Stratio Spark_ por motivos de licencia. Es necesario añadirlo al JAR del _job_ que se quiere ejecutar. Estos _drivers_ están disponibles en el repositorio de Stratio.

El primer paso es crear los secretos en Vault con el usuario/contraseña. Tienes que pedirle al administrador del sistema que lo haga por ti.

* *Ruta de Vault*: `/v1/userland/passwords/s000001-spark-fw/s000001-as400`.
* *Ejecutar en vCLI*: `put s000001-as400 {"user": "<user>", "pass": "<password>"}`.

Después, puedes escribir código normal de Spark. _Stratio Spark_ rellenará las propiedades de usuario/contraseña de Spark con los secretos.

[source,scala]
----
val user = spark.sparkContext.getConf.getOption("spark.db.database1.user")
val password = spark.sparkContext.getConf.getOption("spark.db.database1.pass")

val df = spark.read.
  format("jdbc").
  option("driver", "com.ibm.as400.access.AS400JDBCDriver").
  option("url", "jdbc:as400://external-as400.example.com/DATABASE;prompt=false;naming=sql;errors=full;").
  option("dbtable", "table").
  option("user", user).
  option("password", password).
  load()

df.show()
----

Lanza el _job_ de Spark utilizando _Spark Dispatcher_. Debes establecer estas propiedades en el _job_ para descargar los secretos. El administrador del sistema proporcionará la ruta de Vault.

[source,json]
----
"spark.mesos.driverEnv.SPARK_SECURITY_DB_ENABLE": "true",
"spark.mesos.driverEnv.SPARK_SECURITY_DB_DATABASE1_VAULT_PATH": "/v1/userland/passwords/s000001-spark-fw/s000001-as400",
----

== _Stratio Virtualizer_

=== Acceso al dato

El acceso a los datos se realiza a través de _Stratio Spark_ configurado con el _driver_ de AS/400 JDBC. Consulta <<_stratio_spark, la sección de _Stratio Spark_>> para más información.

=== Autorización/gestión de secretos

_Stratio Virtualizer_ utiliza los métodos de autorización admitidos en _Stratio Spark_. Actualmente, solo está implementada la autorización por usuario/contraseña.

Los secretos pueden almacenarse de forma segura en Vault. También es posible indicar el usuario y contraseña en la frase "``create table``" de _Stratio Virtualizer_ en texto plano. Este método no se recomienda por razones de seguridad.

=== Guía de usuario

Para realizar una prueba, necesitas desplegar la base de datos de AS/400 de antemano.

_Stratio Virtualizer_ soporta tres métodos de configuración de credenciales diferentes:

* "`stratiocredentials`" almacena un secreto diferente por cada base de datos en Vault. Este es el *método recomendado desde la versión 2.22*.
* "`stratiosecurity`" utiliza las credenciales de _Stratio Virtualizer_ (usuario/contraseña) para conectarse a todas las bases de datos. Debes crear las mismas credenciales para cada base de datos.
* Texto sin formato en la frase "``create table``".

El primer paso es crear los secretos en Vault:

* *Ruta de Vault*: `/v1/userland/passwords/s000001-crossdata/s000001-as400`.
* *Ejecutar en vCLI*: `put s000001-crossdata/s000001-as400 {"user": "<user>", "pass": "<pass>"}`.

El siguiente paso es desplegar _Stratio Virtualizer_ usando _Stratio Command Center_. Puedes encontrar la configuración para este conector en la sección _Environment_ → _External data stores_ → _JDBC integration_.

Una vez desplegado, es posible registrar la tabla en el catálogo y ejecutar consultas.

[source,text]
----
create table as400_table using jdbc options (
  url  'jdbc:as400://external-as400.example.com/DATABASE;prompt=false;naming=sql;errors=full;',
  dbtable ‘DATABASE.as400_table',
  stratiosecurity 'true',
  stratiosecuritymode 'user_pass',
  stratiocredentials 's000001-as400'
) AS SELECT 1 AS id, 'Name 1' AS name UNION SELECT 2 AS id, 'Name 2' AS name;

select * from as400_table;
----

== _Stratio Data Governance_

=== Acceso al dato

El acceso a los datos se realiza a través del _driver_ de AS/400 JDBC. Este _driver_ no está incluido por razones de licencia, pero se puede encontrar en el repositorio de Stratio.

El agente de descubrimiento de JDBC (_dg-jdbc-agent_) tiene soporte para el descubrimiento de metadatos de AS/400.

=== Autorización/gestión de secretos

El agente de descubrimiento actualmente solo soporta el método de autorización por usuario/contraseña. Los secretos pueden almacenarse de forma segura en Vault.

:tip-caption: CONSEJO

TIP: Es muy recomendable crear un usuario dedicado para el agente de descubrimiento con permisos limitados.

=== Guía de usuario

Requisitos previos:

* Una instancia de AS/400 en funcionamiento.
* Una instalación de _Stratio Data Governance_.

El primer paso es crear los secretos en Vault. Estos secretos no los crea automáticamente el instalador de _Stratio Command Center_, tienes que pedirle al administrador del sistema que lo haga por ti. Se recomienta encarecidamente crear un nuevo usuario en AS/400 para _Stratio Data Governance_ con permisos limitados.

* *Ruta de Vault*: `/v1/userland/passwords/s000001-dg-as400-agent/s000001-dg-as400-agent`.
* *Ejecutar en vCLI*: `put s000001-dg-as400-agent {"user": "<user>", "pass": "<pass>"}`.

Usa el descriptor de _Stratio Command Center_ para instalar el agente de descubrimiento de JDBC para AS/400: _agent-as400-external-default_.

Los campos más importantes a rellenar en la instalación son:

*General*

* _Backend_ de _Stratio Data Governance_ (PostgreSQL)
 ** _Host_: instancia de PostgreSQL para guardar metadatos de AS/400.
* Configuración del servicio a descubrir:
 ** _Service name_: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Este nombre se mostrará en la interfaz de usuario de _Stratio Data Governance_.
 ** _Host name_: nombre de dominio de la instancia AS/400. Por ejemplo: _external-as400.example.com_.
 ** _Properties_: propiedades de URL de JDBC. El marcador de posición -db- se reemplazará con el nombre de la base de datos del "`init path`". Por defecto: /-db-;prompt=false;naming=sql;errors=full.
 ** _Inith path_: ruta desde la que deseas descubrir los metadatos de forma recursiva. Si no estás seguro, usa el nombre de la base de datos. Por ejemplo: /SAMPLE.
 ** _Vault credentials_: solo se admite MD5 (usuario/contraseña).
 ** _Access credentials_: ruta de Vault con las credenciales de autorización. Por ejemplo: _as400-dev_. La ruta completa será "`userland/passwords/<vault_path>/<access_credentials>`". Consulta el ``vault_path`` a continuación.
* Identidad de servicio:
 ** _Vault role_: se recomienda crear un nuevo rol para los agentes de descubrimiento. Por ejemplo: _s000001-dg-agent_.
* Red de Calico:
 ** _Network name_: es necesario utilizar la red compartida de stratio si el agente de descubrimiento está configurado para guardar los metadatos en Postgreseos.

*Ajustes*

* Configuración del servicio descubierto:
 ** _Driver’s JAR URL_: URL para descargar el _driver_ AS/400. Hay una copia del artefacto en el repositorio de Stratio.
* Ruta de secretos:
 ** _Vault path_: ruta de Vault con los credenciales de autorización. Por defecto, es <tenantId>-<serviceId>. Por ejemplo: _s000001-dg-as400-agent_.

Comprueba que el servicio se despliega, es capaz de descargar el _driver_ y los secretos y que el proceso de descubrimiento comienza. La primera vez puede tardar un tiempo.

Si el servicio funciona correctamente, puedes ver los metadatos descubiertos en las trazas:

[source,text]
----
Extract begins at: Fri Mar 27 09:56:05 CET 2020
NewOrUpdate 14 DataAssets begins at: Fri Mar 27 09:56:06 CET 2020
Delete 0 DataAssets begins at: Fri Mar 27 09:56:07 CET 2020
Synchronizing 14 and 0 Federated DataAssets begins at Fri Mar 27 09:56:07 CET 2020
----

En la interfaz de usuario de _Stratio Data Governance_ puedes ver que se ha descubierto un nuevo almacén de datos y puedes examinar los metadatos. Todas las tablas, columnas, tipos de datos, claves primarias, claves foráneas... han sido detectadas correctamente.

image::external-as400-connector-governance.png[]

El agente actualiza los metadatos periódicamente. Se puede realizar una prueba, por ejemplo, lanzando un "ALTER TABLE" en AS/400 y esperando a que el agente detecte el cambio. Estos cambios se reflejan en la interfaz de usuario de _Stratio Data Governance_.

== _Stratio Rocket_

Hay diferentes posibilidades para acceder al almacén de datos de AS/400 desde _Stratio Rocket_. La manera recomendada es utilizar la integración con _Stratio Virtualizer_ ya que implementa todos los mecanismos de seguridad. También es posible utilizar la entrada/salida de JDBC o incluso la entrada de la fuente de datos y la salida del almacén de datos.

Consulta en la documentación de xref:stratio-rocket:user-guide:workflow-asset.adoc[_Stratio Rocket_] para obtener más información sobre cómo configurar estos pasos.

== _Stratio GoSec_

Los almacenes de datos externos no se integran con _Stratio GoSec_.

La autorización se configurará directamente en la base de datos cuando se cree el usuario para _Stratio Virtualizer_/_Stratio Spark_/_Stratio Data Governance_.

:tip-caption: CONSEJO

TIP: Se recomienda crear un usuario específico para cada aplicación con permisos limitados.

La mayoría de los módulos accederán al almacén de datos a través de _Stratio Virtualizer_. Esto te permite configurar diferentes políticas de autorización para cada usuario en _Stratio GoSec_.

Los secretos (usuario/contraseña) se pueden almacenar en Vault de forma segura. _Stratio Virtualizer_/_Stratio Spark_/_Stratio Data Governance_ tienen mecanismos para descargar los secretos y usarlos cuando sea necesario.
