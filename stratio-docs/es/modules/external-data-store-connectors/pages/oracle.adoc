= Oracle

Este documento explica cómo acceder al almacén de datos de Oracle (que no está incluido dentro de la plataforma de Stratio) desde cada módulo de la plataforma. Es posible desplegarlo en la plataforma con las imágenes oficiales de Docker, aunque no todas las versiones de Oracle tienen imágenes de Docker.

:note-caption: AVISO

NOTE: El _software_ de IBM tiene licencia comercial, por lo que es necesario el registro y la aceptación de los términos de la licencia.

== Matriz de soporte

|===
| Módulo | Versiones | Oracle 12.2 | Oracle 18.3 | Oracle 19.3

| _Stratio Spark_
| ≥ 2.4.4-3.0.0
| OK
| OK
| OK

| _Stratio Virtualizer_
| ≥ 2.20.0
| OK
| OK
| OK

| _Stratio Data Governance_
| ≥ 1.5.0
| OK
| OK
| OK

| _Stratio Rocket_
| ≥ 1.0.0
| OK
| OK
| OK

| _Stratio Sparta_
| ≥ 2.14
| OK
| OK
| OK

| _Stratio Intelligence_
| -
| -
| -
| -

| _Stratio BDL_
| ≥ 1.5.0
| OK
| OK
| OK
|===

:note-caption: AVISO

NOTE: Los módulos sin versiones no han sido probados aún. Podrían estar soportados.

== Rendimiento/optimizaciones

El valor predeterminado en Oracle para https://docs.oracle.com/cd/B13789_01/java.101/b10979/oraperf.htm#i1043756[_defaultRowPrefetch_] es 10. Este valor puede ralentizar las consultas al pedir grandes cantidades de datos.

Después de varias pruebas, hemos concluido que en la mayoría de los casos de uso es conveniente aumentar el valor a 10000. Aumentar aún más el valor no muestra una mejora en los resultados.

Este parámetro debe configurarse directamente en el _string_ de conexión de JDBC: `jdbc:oracle:thin:@127.0.0.1:1521/orclpdb1?defaultRowPrefetch=10000`.

Además, el conector de Oracle JDBC tiene otro parámetro que convierte todos los tipos de datos a _Timestamp_, causando inconsistencias en la información recuperada por _Stratio Data Governance_ y el tipo de datos en la base de datos.

Este problema puede resolverse al https://spark.apache.org/docs/latest/sql-data-sources-troubleshooting.html[establecer una opción en Spark]:

[source,scala]
----
spark.read
        .format("jdbc")
        .option("url", oracleJdbcUrl)
        .option("oracle.jdbc.mapDateToTimestamp", "false")
----

== _Stratio Spark_

=== Acceso al dato

Spark tiene soporte oficial para el conector de Oracle JDBC (incluye clases para soportar el Oracle _dialect_).

_Stratio Spark_ no ha modificado Spark para este conector.

=== Autorización/gestión de secretos

Oracle soporta muchos métodos de autorización (usuario/contraseña, SSL, Kerberos... ). Actualmente, en _Stratio Spark_ solo se soporta la autorización usuario/contraseña.

Estas credenciales pueden almacenarse de forma segura en Vault y _Stratio Spark_ puede recuperarlas y usarlas para establecer la conexión.

_Stratio Spark_ permite configurar varias bases de datos de JDBC en el mismo _job_, cada una con sus propios secretos. Debes configurar una variable de entorno para cada base de datos:

[source,json]
----
"spark.mesos.driverEnv.SPARK_SECURITY_DB_<BD_NAME_UPPER_CASE>_VAULT_PATH"
----

Al hacer esto, Spark podrá descargar los secretos necesarios desde Vault y establecer las siguientes propiedades por ti:

[source,json]
----
"spark.db.<db_name_lower_case>.user",
"spark.db.<db_name_lower_case>.pass"
----

=== Guía de usuario

El _driver_ de Oracle no está incluido en _Stratio Spark_ por motivo de licencias. Es necesario añadirlo al JAR del _job_ que se quiere ejecutar. Estos _drivers_ están disponibles en el repositorio de Stratio.

1) El primer paso es crear los secretos en Vault con el usuario/contraseña. Tendrás que pedirle al administrador de sistemas que lo haga por ti.

* *Ruta de Vault*: `/v1/userland/passwords/s000001-spark-fw/s000001-oracle`.
* *Ejecutar en vCLI*: `put s000001-oracle {"user": "<user>", "pass": "<password>"}`.

2) Después, puedes escribir código normal de Spark. _Stratio Spark_ rellenará las propiedades de los usuarios/contraseñas de Spark con los secretos.

[source,scala]
----
val user = spark.sparkContext.getConf.getOption("spark.db.database1.user")
val password = spark.sparkContext.getConf.getOption("spark.db.database1.pass")

val df = spark.read.
  format("jdbc").
  option("driver", "oracle.jdbc.driver.OracleDriver").
  option("url", "jdbc:oracle:thin:@s000001-oracle.s000001.marathon.mesos:1521/orclpdb1.localdomain?defaultRowPrefetch=10000").
  option("dbtable", "table").
  option("user", user).
  option("password", password).
  load()

df.show()
----

3) Lanza el _job_ de Spark utilizando _Spark Dispatcher_. Necesitas configurar estas propiedades en el _job_ para descargar los secretos. El administrador del sistema proporcionará la ruta de Vault.

[source,json]
----
"spark.mesos.driverEnv.SPARK_SECURITY_DB_ENABLE": "true",
"spark.mesos.driverEnv.SPARK_SECURITY_DB_DATABASE1_VAULT_PATH": "/v1/userland/passwords/s000001-spark-fw/s000001-oracle",
----

== _Stratio Virtualizer_

=== Acceso al dato

El acceso a los datos se realiza a través de _Stratio Spark_ configurado con el _driver_ de Oracle JDBC. Mira en <<_stratio_spark, la sección de _Stratio Spark_>> para más información.

=== Autorización/gestión de secretos

_Stratio Virtualizer_ usa los métodos de autorización soportados en _Stratio Spark_. Actualmente, solo está implementada la autorización por usuario/contraseña.

Los secretos pueden almacenarse de forma segura en Vault. También es posible indicar el usuario y contraseña en la sentencia de _"create table"_ de _Stratio Virtualizer_ en texto plano. Este método no está recomendado por razones de seguridad.

=== Guía de usuario

Con el fin de llevar a cabo una prueba, necesitas desplegar la base de datos de Oracle de antemano.

_Stratio Virtualizer_ soporta tres métodos de configuración de credenciales diferentes:

* "`stratiocredentials`" almacena un secreto diferente por cada base de datos en Vault. Este es el método recomendado desde la versión 2.22.
* "`stratiosecurity`" usa las credenciales de _Stratio Virtualizer_ (usuario/contraseña) para conectar a todas las bases de datos. Tienes que crear las mismas credenciales para cada base de datos.
* Texto plano en la sentencia de "``create table``".

1) El primer paso es crear los secretos en Vault:

* *Ruta de Vault*: `/v1/userland/passwords/s000001-crossdata/s000001-oracle`.
* *Ejecutar en vCLI*: `put s000001-crossdata/s000001-oracle {"user": "<user>", "pass": "<pass>"}`.

2) Después, despliega _Stratio Virtualizer_ usando _Stratio Command Center_. Puedes encontrar la configuración para este conector en la sección *Environment → External data stores → JDBC integration*.

:note-caption: AVISO

NOTE: El descriptor de _Stratio Command Center_ está disponible desde la versión 2.22.0. Para versiones anteriores, debes hablar con el administrador del sistema.

3) Una vez desplegado, es posible registrar la tabla en el catálogo y ejecutar consultas.

[source,text]
----
create table oracle_table using jdbc options (
  url 'jdbc:oracle:thin:@s000001-oracle.s000001.marathon.mesos:1521/orclpdb1.localdomain?defaultRowPrefetch=10000',
  dbtable 'oracle_table',
  stratiosecurity 'true',
  stratiosecuritymode 'user_pass',
  stratiocredentials 's000001-oracle'
) AS SELECT 1 AS id, 'Name 1' AS name UNION SELECT 2 AS id, 'Name 2' AS name;

select * from oracle_table;
----

== _Stratio Data Governance_

=== Acceso al dato

El acceso a los datos se realiza a través del _driver_ de Oracle JDBC. Este _driver_ no está incluido por motivo de licencias, pero se puede encontrar en el repositorio de Stratio.

El agente de descubrimiento de JDBC (_dg-jdbc-agent_) tiene soporte para el descubrimiento de metadatos de Oracle.

=== Autorización/gestión de secretos

El agente de descubrimiento actualmente solo soporta el método de autorización por usuario/contraseña. Los secretos pueden almacenarse de forma segura en Vault.

* *Ruta de Vault*: `/v1/userland/passwords/s000001-dg-oracle-agent/s000001-dg-oracle-agent`.
* *Ejecutar en vCLI*: `put s000001-dg-oracle-agent {"user": "<user>", "pass": "<password>"}`.

:tip-caption: CONSEJO

TIP: Es muy recomendable crear un usuario dedicado para el agente de descubrimiento con permisos limitados.

=== Guía de usuario

Requisitos previos:

* Una instancia de Oracle en funcionamiento.
* Una instalación de _Stratio Data Governance_.

1) El primer paso es crear los secretos en Vault. Estos no se crean automáticamente por el instalador de _Stratio Command Center_, por lo que debes pedirle al administrador del sistema que lo haga por ti.

:tip-caption: CONSEJO

TIP: Es muy recomendable crear un nuevo usuario en Oracle para _Stratio Data Governance_ con permisos limitados.

2) Usa el descriptor de _Stratio Command Center_ para instalar el agente de descubrimiento de JDBC para Oracle: _agent-oracle-external-default_.

Los campos más importantes a rellenar en la instalación son:

*General*

* _Backend_ de _Stratio Data Governance_ (PostgreSQL)
 ** _Host_: instancia de PostgreSQL para guardar metadatos de Oracle.
* Configuración del servicio a ser descubierto
 ** _Service name_: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Este nombre se mostrará en la interfaz de usuario de _Stratio Data Governance_.
 ** _Host name_: nombre de dominio de la instancia de Oracle. Puede ser interna o externa a la plataforma de Stratio. Por ejemplo: s000001-oracle.s000001.marathon.mesos.
 ** _Port_: puerto de Oracle. Por defecto: 1521.
 ** _Properties_: propiedades de JDBC URL. El marcador de posición -db- será reemplazado por el nombre de la base de datos del "`init path`". Por defecto: ``/-db-?defaultRowPrefetch=10000``.
 ** _Init path_: ruta desde la cual quieres descubrir los metadatos de forma recursiva. Si no estás seguro, usa el nombre de la base de datos. El dominio de Oracle se puede encontrar en el archivo _tnsnames.ora_ o en los _logs_ cuando se inicia la imagen oficial de Docker de Oracle. El dominio por defecto para la imagen oficial de Docker de Oracle es /ORCLPDB1.localdomain.
 ** _Vault credentials_: solo MD5 (usuario/contraseña) está soportado.
 ** _Access credentials_: ruta de Vault con las credenciales de autorización. Por ejemplo: oracle-dev. La ruta completa será "`userland/passwords/<vault_path>/<access_credentials>`". Mira el ``vault_path`` de abajo.
* Identidad de servicio
 ** _Vault role_: se recomienda crear un nuevo rol para los agentes de descubrimiento. Por ejemplo: s000001-dg-agent.
* Red de Calico
 ** _Network name_: es necesario utilizar la red compartida de Stratio si el agente de descubrimiento está configurado para guardar los metadatos en Postgreseos.

*Ajustes*

* Configuración de servicio descubierto
 ** _Driver's JAR URL_: URL para descargar el _driver_ de Oracle. Hay una copia del artefacto en el repositorio de Stratio.
* Ruta de secretos
 ** _Vault path_: ruta de Vault con las credenciales de autorización. Por defecto es <tenantId>-<serviceId>. Por ejemplo: s000001-dg-oracle-agent.

3) Comprueba que el servicio se despliega, es capaz de descargar el _driver_ y los secretos y que el proceso de descubrimiento comienza. La primera vez puede tardar un tiempo.

Si el servicio funciona correctamente, puedes ver los metadatos descubiertos en las trazas:

[source,text]
----
Extract begins at: Fri Mar 27 09:56:05 CET 2020
NewOrUpdate 14 DataAssets begins at: Fri Mar 27 09:56:06 CET 2020
Delete 0 DataAssets begins at: Fri Mar 27 09:56:07 CET 2020
Synchronizing 14 and 0 Federated DataAssets begins at Fri Mar 27 09:56:07 CET 2020
----

4) En la interfaz de usuario de _Stratio Data Governance_ puedes ver que se ha descubierto un nuevo almacén de datos y puedes navegar por los metadatos. Todas las tablas, columnas, tipos de datos, claves primarias, claves foráneas... han sido detectadas correctamente.

image::external-oracle-connector-governance.png[]

El agente actualiza los metadatos periódicamente. Se puede realizar una prueba, por ejemplo, lanzando un "ALTER TABLE" en Oracle y esperando a que el agente detecte el cambio. Estos cambios se reflejan en la interfaz de usuario de _Stratio Data Governance_.

== _Stratio Rocket_/_Stratio Sparta_

Hay diferentes posibilidades para acceder al almacén de datos de Oracle desde _Stratio Rocket_. La manera recomendada es utilizar la integración con _Stratio Virtualizer_, ya que implementa todos los mecanismos de seguridad. También es posible utilizar la entrada/salida de JDBC o incluso la fuente de datos de entrada y el almacén de datos de salida.

Mira en la documentación de xref:stratio-rocket:user-guide:workflow-asset-user-guide.adoc[_Stratio Rocket_] para más información sobre cómo configurar estos pasos.

== _Stratio GoSec_

Los almacenes de datos externos no se integran con _Stratio GoSec_.

La autorización se configurará directamente en la base de datos cuando se cree el usuario para _Stratio Virtualizer_/_Stratio Spark_/_Stratio Data Governance_.

:tip-caption: CONSEJO

TIP: Se recomienda crear un usuario específico para cada aplicación con permisos limitados.

La mayoría de los módulos accederán al almacén de datos a través de _Stratio Virtualizer_. Esto te permite configurar diferentes políticas de autorización para cada usuario en _Stratio GoSec_.

Los secretos (usuario/contraseña) se pueden almacenar en Vault de forma segura. _Stratio Virtualizer_/_Stratio Spark_/_Stratio Data Governance_ tienen mecanismos para descargar los secretos y usarlos cuando sea necesario.

== Problemas conocidos

* El descriptor de _Stratio Command Center_ incluye soporte para este almacén de datos desde la versión 2.22.0. Para versiones anteriores, tienes que desplegar _Stratio Virtualizer_ y, después, cambiar algunas variables de entorno.
* *Versión del _driver_:* al escoger un _driver_ de Oracle JDBC, es importante tener en cuenta que Stratio usa Java 8. Por esto, *debes utilizar el ``ojdbc8.jar``* (esto significa que es compatible con Java 8).
