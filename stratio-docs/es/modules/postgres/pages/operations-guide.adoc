= Guía de operaciones

== Descripción

El conector SSCC PostgreSQL® te permite la integración de PostgreSQL® en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:postgres:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

El conector soporta dos modos de autenticación:

* Usuario/contraseña.
* mTLS (_Transport Layer Security_ mutuo).

Como se verá más adelante, según el modo elegido habrá que usar unos valores de configuración y credenciales específicas en cada uno de los servicios de _Stratio Generative AI Data Fabric_.

== Prerrequisitos

* Si quieres usar un PostgreSQL® instalado dentro de la plataforma _Stratio Generative AI Data Fabric_, es necesario:

. El _framework_ de PostgreSQL® instalado.

* Si quieres usar un PostgreSQL® externo a la plataforma, necesitas:

. Tener una instancia de una base de datos PostgreSQL® accesible desde _Stratio Generative AI Data Fabric_ con el modo de autenticación elegido configurado:
** Para la autenticación básica, hará falta un usuario con los permisos adecuados y su contraseña.
*** Adicionalmente, la autenticación MD5 de PostgreSQL® puede realizarse bajo TLS, mutuo o no. Si el servidor lo requiere el cliente deberá proporcionar:
**** El certificado de la CA.
**** El certificado del usuario que va a hacer login en PostgreSQL®
**** La clave privada del usuario que va a hacer login en el PostgreSQL (igual que en mTLS)
** Para configurar la autenticación con TLS mutuo en los servicios de la plataforma, necesitarás:
*** El certificado de la CA.
*** El certificado del usuario que va a hacer _login_ en PostgreSQL®.
*** La clave privada del usuario que va a hacer _login_ en PostgreSQL®.

. Tener una URL JDBC para la conexión con la base de datos PostgreSQL®.
. Instalar el xref:connectors-repository:operations-guide.adoc#_instalación[repositorio de conectores]:
+
Visita la sección de la xref:connectors-repository:operations-guide.adoc#_instalación[Guía de operaciones] para averiguar cómo instalar el repositorio.
+
NOTE: En el repositorio de conectores se tendrá disponible en la URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<nombre_artefacto>` el artefacto usado en esta guía: `sscc-postgresql-0.3_2.12-1.1.x.jar`.
+
. Tener accesible la interfaz de usuario de _Stratio KMS_ para la gestión de credenciales:
+
Visita la sección de la xref:ROOT:quick-start-guide.adoc#access-kms-ui[interfaz de usuario de _Stratio KMS_] para consultar los pasos necesarios para tenerla disponible.
+
. Crear los secretos en _Stratio KMS_. Para ello debes acceder a `https://<stratio_kms_ui_url>/ui/vault/secrets` y crear un secreto en la carpeta correspondiente del servicio con las siguientes opciones según el modo de autenticación:
+
--
** Usuario/contraseña
*** *_user_*: <user_with_db_access_permissions>, corresponde al usuario con el que se va a acceder a PostgreSQL®.
*** *_password_*: <user_password>, corresponde a la contraseña asociada al usuario.
+
En el caso de que la conexión se realice mediante TLS
*** *_<nombre_secreto>.postgresql-client-rootcert_*: <postgresql_ca_certificate_pem>, Certificado de la CA
+
*Y si el servidor lo require como requisito:*
*** *_<nombre_secreto>.postgresql-client-cert_*: <postgresql_client_certificate_pem>, Certificado del usuario que se va a conectar
*** *_<nombre_secreto>.postgresql-client-key_*: <postgresql_client_key_pem>, Clave privada del usuario que se va a conectar
+
IMPORTANT: El nombre de usuario que se utiliza en la conexión y el _Common Name (CN)_ del certificado del cliente, *_<nombre_secreto>.postgresql-client-cert_* deben de coincidir.
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:
+
**** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>/<nombre_secreto>`.
**** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
**** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
**** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
**** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.
+
NOTE: El nombre y los valores del secreto para todos los servicios deben coincidir con los elegidos para configurar el agente de descubrimiento.
+
--

** TLS mutuo (mTLS)
*** *<nombre_secreto>.postgresql-client-rootcert*: `<postgresql_ca_certificate_pem>`, certificado de la CA.
*** *<nombre_secreto>.postgresql-client-cert*: `<postgresql_client_certificate_pem>`, certificado del usuario que se va a conectar.
*** *<nombre_secreto>.postgresql-client-key*: `<postgresql_client_key_pem>`, clave privada del usuario que se va a conectar.
+
IMPORTANT: El usuario que se utiliza en la conexión se obtiene del _Common Name_ (CN) del certificado del cliente, *<nombre_secreto>.postgresql-client-cert*. Si el certificado PEM es una cadena de certificados, se toma el primero como principal y se obtiene de este el usuario de conexión.
+
IMPORTANT: La clave *<nombre_secreto>.postgresql-client-key* debe estar en formato PEM. Si tienes una _key_ RSA, utiliza `openssl pkey -in postgres_rsa.key`.
+
image::postgres-vault-tls-conf.png[]
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:
+
**** *Agente de descubrimiento*: `userland/certificates/<nombre_agente>`.
**** *_Stratio Virtualizer_*: `userland/certificates/<nombre_virtualizer>.<namespace_virtualizer>`.
**** *_Stratio Rocket_*: `userland/certificates/<nombre_rocket>.<namespace_rocket>`.
**** *_Workflows_ de _Stratio Rocket_*: `userland/certificates/execution-identity-<nombre_rocket>.<namespace_rocket>`.
**** *_Stratio Intelligence_*: `/people/certificates/<nombre_usuario_intelligence>`.

== Descubre tus datos

=== Agente de descubrimiento

* Para instalar un agente de descubrimiento de _Stratio Data Governance_ para un PostgreSQL® externo a la plataforma debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS'* el agente "PostgreSQL® Agent (External)".
+
Los campos a rellenar para la instalación son:
+
** *General*:
*** *_Service ID_*: identificador único del agente.
*** *_Name of the Service_*: nombre mostrado en _Stratio KEOS_.
** *Metadata Data store (PostgreSQL®)*
*** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
** *Configuration of the Service to be Discovered*
*** *_Service name_*: nombre del servicio. Ejemplo: _dg-postgresql-agent_.
*** *_Root discovery path_*: bases de datos que serán descubiertas. Ejemplo: _/db1,/db2_.
*** *_Custom Service URL_*: URL JDBC usada para conectarse a PostgreSQL®. Ejemplo: _jdbc:postgresql://dbsqa.labs.stratio.com:5432/-db-_.
*** *_Custom datastore service security_*: tipo de autenticación usada para la conexión: MD5 (usuario/contraseña) o TLS mutuo.
*** *_Access credentials_*: nombre del secreto creado en xref:#create-secret[_Stratio KMS_]. Ejemplo: _postgresql-secret_.
*** *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del conector SSCC PostgreSQL®. Ejemplo: _http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-postgresql-0.3_2.12-1.1.x.jar_.
+
image::postgres-cct-deployment.png[]
+
*** *Vault password retrieval*
**** *_Vault credentials_*: habilita SSL o usuario/contraseña para la autenticación.
**** *_Access credentials_*: ruta donde se almacenan las credenciales en _Stratio KMS_, se usa en caso de autenticación usuario/contraseña.
+
image::postgres-cct-deployment2.png[]
+
*** *_Enable optimization engine_*: activa/desactiva la optimización automática del almacén de datos de PostgreSQL®.
**** *_Granularity Optimizer Level_*: se define el nivel de granularidad/profundidad de la optimización. Los valores posibles son "1" y "2":
***** *Nivel 1*: la optimización se realiza utilizando únicamente metadatos y estadísticas del almacén de datos. Por defecto está en este nivel.
***** *Nivel 2*: además de los análisis del nivel 1, realiza un análisis en mayor profundidad de la distribución de los datos de las tablas mediante técnicas de inferencia y muestreo.
+
IMPORTANT: Para el *nivel 2* es necesario tener permisos de acceso al dato en las tablas que se deseen optimizar. Este nivel puede ralentizar el proceso de descubrimiento.
+
**** *_Force create statistics_*: activa/desactiva la creación forzada de las estadísticas requeridas para la optimización. Por defecto está desactivado, asumiendo que las estadísticas ya están creadas.
+
NOTE: Se recomienda que el administrador de la base de datos genere previamente las estadísticas desde el almacén de datos de PostgreSQL® para aquellas tablas que se deseen optimizar.
+
**** *_Sampling Percent_*: porcentaje de muestreo para la optimización de nivel 2. Esta variable sólo aparece cuando se elige el _Granularity optimization engine_ con valor "2".
+
El valor es el porcentaje en tanto por 1. Por defecto, está en "0.65", que corresponde a un muestreo del 65%.
+
**** *_Optimizer Parallelism Level_*: número de hilos que se usarán para la optimización.
+
image::postgres-optimizer-sscc-conf-operations.png[]

* Para instalar un agente de descubrimiento de _Stratio Data Governance_ para un PostgreSQL® interno a la plataforma debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS'* el agente "PostgreSQL® Agent (Internal)".
+
Los campos a rellenar para la instalación son:
+
** *Pre-deployment*:
*** *_Define a namespace_*: selecciona el espacio de nombres sobre el que quieras instalar el agente de descubrimiento.
*** *_PostgreSQL® to be discovered_*: selecciona el servicio PostgreSQL® que quieras descubrir.
*** *_PostgreSQL® used for policy creation_*: selecciona el PostgreSQL® utilizado para la creación de políticas.
+
image::postgres-internal-cct-deployment.png[]

** *General*:
*** *_Service ID_*: identificador único del agente.
*** *_Name of the Service_*: nombre mostrado en _Stratio KEOS_.
** *Metadata Datastore (PostgreSQL®)*
*** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
*** *_Database_*: base de datos PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _postgreskeos_.
** *Configuration of the Service to be Discovered*
*** *_Port_*: puerto del servicio PostgreSQL®. Ejemplo: _5432_.
*** *_Init path_*: bases de datos que serán descubiertas. Ejemplo: _/db1,/db2_.
*** *_Vault credentials_*: tipo de autenticación usada para la conexión. Ejemplo: TLS mutuo.
+
image::postgres-internal-cct-deployment2.png[]

El proceso de descubrimiento es asíncrono. Una vez terminado, se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::postgres-discover-metadata.png[]

NOTE: Las vistas en PostgreSQL® están soportadas pero se muestran como tablas en la interfaz de usuario de _Stratio Data Governance_.

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Modos _legacy_ y _path_

Existen dos modos de descubrimiento:

* _Legacy_ (en desuso)

Selecciona el campo _Use legacy mode_ con el valor "true" para activarlo.

image::postgres-mode-legacy-conf.png[]

* _Path_

Selecciona el campo _Use legacy mode_ con el valor "false" para activarlo.

image::postgres-mode-sscc-conf.png[]

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de PostgreSQL®. Para ello basta con añadir la URL del artefacto necesario en la variable `Additional jars` en el formulario de modificación del servicio en _Stratio Command Center_:

* 'Customized deployment' -> 'Settings' -> `Additional jars`: _http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-postgresql-0.3_2.12-1.1.x.jar_.
+
image::postgres-bdl-conf.png[]
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

=== _Stratio Virtualizer_

Para el uso de _Stratio Virtualizer_ es necesario tener configurado el conector de PostgreSQL®. Para ello, debes subir las credenciales de acceso a _Stratio KMS_ y añadir las URL de los artefactos necesarios en la variable `JDBC Drivers URL List` en el formulario de modificación del servicio _Stratio Virtualizer_ en _Stratio Command Center_:

* 'Customized deployment' -> 'Environment'
+
--
** *_Use default Native Connectors plugin_*: deshabilitado. (Deshabilitar para que use el dialecto nativo del propio conector instalado y no el de por defecto).
** *_JDBC Integration_*: habilitado.
** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-postgresql-0.3_2.12-1.1.x.jar`.
--
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.
+
image::postgres-virtualizer-conf.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para el uso de _Stratio Rocket_ es necesario tener configurado el conector de PostgreSQL®. Para ello, debes subir las credenciales de acceso a _Stratio KMS_ para los _workflows_ y para _Stratio Rocket_ y añadir las URL de los artefactos necesarios en la variable `Rocket extra jars` en el formulario de modificación del servicio _Stratio Rocket_ en _Stratio Command Center_:

* 'Customized deployment' -> 'Settings' -> 'Classpath'
+
--
** *_Include Crossdata native connector library_*: deshabilitado. (Deshabilitar para que use el dialecto nativo del propio conector instalado y no el de por defecto).
** *_Include Crossdata native engine library_*: habilitado.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-postgresql-0.3_2.12-1.1.x.jar`.
--
+
NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.
+
image::postgres-rocket-conf.png[]

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `org.postgresql.Driver:com.stratio.connectors.ssccpostgresql.PostgreSQLQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_url_jdbc_postgres>.port.<port_url_jdbc_postgres>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccpostgresql.PostgreSQLDriverMD5:com.stratio.connectors.ssccpostgresql.PostgreSQLQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la configuración correcta de _Stratio Intelligence_ consulta la xref:postgres:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_], recordando que hay que usar el formato adecuado al modo de autenticación para los secretos.

=== Notas _include/skip databases/schema/tables_

Estos son los métodos de filtrado o inclusión de tablas y/o esquemas:

* _Included/Skipped resource paths regular expression (databases/schemas)_
+
En el ejemplo de la imagen se muestra cómo en este caso se saltará esa base de datos/esquema.

* _Included/Skipped resource names regular expression (tables)_
+
En el ejemplo de la imagen también se muestra cómo en este caso se saltará esa tabla.

image::postgres-discover-metadata-skip-conf.png[]

image::postgres-discover-metadata-skip.png[]
