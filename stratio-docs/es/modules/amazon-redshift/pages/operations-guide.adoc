= Guía de operaciones

== Descripción

El conector SSCC Amazon Redshift te permite la integración de Amazon Redshift en _Stratio Generative AI Data Fabric_.

Las funcionalidades y versiones soportadas se encuentran en la xref:amazon-redshift:compatibility-matrix.adoc[matriz de compatibilidad].

=== Autenticación

Amazon Redshift admite dos tipos de credenciales de seguridad:

* Las de *largo plazo*, que pueden ser usuarios _Root_, usuarios IAM y claves de acceso. Tienen acceso permanente a la plataforma.
* Las *temporales*, que pueden ser roles de IAM, usuarios de AWS IAM Identity Center (sucesor de AWS Single Sign-On) y usuarios federados. Pueden tener acceso temporal.

El método de autenticación incluido en el conector es _Service Account_ o _Access Key_ (credenciales básicas), que permite la autenticación permanente de una cuenta de servicio mediante _accessKey_ y _secretKey_.

== Prerrequisitos

. Disponer de credenciales a una cuenta de servicio de Amazon AWS accesible desde _Stratio Generative AI Data Fabric_ con xref:_autenticación[autenticación soportada].
. Tener accesible la interfaz de usuario de _Stratio KMS_ para la gestión de credenciales. Visita la sección de la xref:ROOT:quick-start-guide.adoc[guía de inicio rápido general] para consultar los pasos necesarios para disponibilizarla.
. Crear los secretos en _Stratio KMS_. Para ello debes acceder a `https://<stratio_kms_ui_url>/ui/vault/secrets` y crear un secreto en la carpeta correspondiente del servicio con las siguientes opciones según el modo de autenticación:
+
--
* _Service Account_
** Si solamente se accede a instancias de tipo `serverless`.
+
[source,json]
----
{..
  "accessKey": "<AWS-ACCESS-KEY>",
  "secretKey": "<AWS-SECRET-KEY>"
}
----
+
** Si se accede a alguna instancia de tipo `provisionedCluster`.
+
[source,json]
----
{..
  "accessKey": "<AWS-ACCESS-KEY>",
  "secretKey": "<AWS-SECRET-KEY>",
  "user": "<REDSHIFT-BD-USER>"
}
----
+
IMPORTANT: El usuario de la base de datos del campo _user_ se utilizará para la conexión a todas las instancias de tipo `provisionedCluster`. Por lo tanto, deberá existir en todas ellas.
+
--
+
Este secreto se debe subir a los siguientes directorios de _Stratio KMS_:
+
--
** *Agente de descubrimiento*: `userland/passwords/<nombre_agente>.<namespace_agente>/<nombre_secreto>`.
** *_Stratio Virtualizer_*: `userland/passwords/<nombre_virtualizer>.<namespace_virtualizer>/<nombre_secreto>`.
** *_Stratio Rocket_*: `userland/passwords/<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Workflows_ de _Stratio Rocket_*: `userland/passwords/execution-identity-<nombre_rocket>.<namespace_rocket>/<nombre_secreto>`.
** *_Stratio Intelligence_*: `/people/passwords/<nombre_usuario_intelligence>/<nombre_secreto>`.
+
NOTE: El nombre y los valores del secreto para todos los servicios deben coincidir con los elegidos para configurar el agente de descubrimiento.
--

== Descubre tus datos

=== Agente de descubrimiento

Para instalar un agente de descubrimiento de _Stratio Data Governance_ para Amazon Redshift debes seleccionar en '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors Data Warehouse' el agente "Redshift Agent".

Los campos a rellenar para la instalación son:

* *_General_*
** *_Service ID_*: identificador único del agente. Ejemplo: _dg-redshift-agent_.
** *_Service name_*: nombre mostrado en _Stratio KEOS_. Ejemplo: _dg-redshift-agent_.
* *Metadata Datastore (PostgreSQL®)*
** *_Host_*: instancia de PostgreSQL® que almacena los metadatos descubiertos. Ejemplo: _pgbouncer-postgreskeos-governance.keos-core_.
* *Configuration of the Service to be Discovered*
** *Service to be discovered:*
*** *_Service name_*: nombre que se utilizará para identificar este almacén de datos en _Stratio Data Governance_. Es el que se mostrará en su interfaz de usuario. Ejemplo: _dg-redshift-agent_.
*** *_Root discovery path_*: los _workgroups/clusters_ de Amazon Redshift que quieras que sean descubiertos. Deben estar separados por comas, sin espacios y con una `/` al principio.
**** Se usa `/` para descubrir todas las instancias de Amazon Redshift a las que tenga acceso la política de autorización de Amazon AWS.
**** Es recomendable prefijar con el tipo (`serverless-` o `provisionedCluster-`) las instancias a descubrir para evitar ambigüedades.
+
image::redshift-cct-deployment1.png[]

** *Resource datastore connection configuration*
*** *_Custom data store service security_*: tipo de seguridad a utilizar: _ServiceAccount_.
*** *_Access credentials_*: nombre del secreto creado en xref:#create-secret[_Stratio KMS_]. Ejemplo: _redshift-secret_.
*** *_Redshift custom endpoint region_*: región usada en el _endpoint_ por defecto.
*** *_Redshift Native Mode_*: los posibles valores son "True" si el usuario quiere virtualizar con el conector nativo de _Stratio Virtualizer_ y "False" si quiere virtualizar sin modo nativo.
*** *_SSCC driver location_*: URL donde se encuentra el artefacto en el repositorio de conectores que contendrá el JAR del conector SSCC Amazon Redshift. Ejemplo: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-redshift-0.3_2.12-1.0.x.jar`.
+
image::redshift-cct-deployment2.png[]

El proceso de descubrimiento es asíncrono, una vez terminado el descubrimiento se podrá visualizar desde la interfaz de usuario de _Stratio Data Governance_.

image::redshift-discover-metadata.png[]

== Virtualiza tus datos

IMPORTANT: Ten en cuenta que para virtualizar las tablas descubiertas es necesario gestionar las xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[políticas de dominios] a través de _Stratio GoSec_.

=== Agente de Eureka

Para el uso de la BDL es necesario configurar el agente de Eureka con el conector de SSCC Amazon Redshift. Para ello, basta con añadir la URL del repositorio de conectores del artefacto `sscc-redshift-0.3_2.12-1.0.x` en la variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

image::redshift-bdl.png[]

NOTE: Recuerda que, si ya tienes más de un artefacto en la lista, se deben añadir los siguientes separándolos por una coma.

TIP: Consulta aquí xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[más información acerca del procesamiento de datos con BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ soporta la interacción con Amazon Redshift a través del conector SSCC Amazon Redshift. Esta integración tiene ciertos requisitos:

* Se deben modificar los siguientes campos del despliegue de _Stratio Virtualizer_ en _Stratio Command Center_:
+
--
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-redshift-0.3_2.12-1.0.x.jar`.
--
+
image::redshift-virtualizer-conf.png[]

== Transforma tus datos

=== _Stratio Rocket_

==== Gestión del _driver_

Para que el conector funcione, las bibliotecas propietarias de Amazon Redshift deben agregarse al _classpath_.

Para el uso de _Stratio Rocket_ es necesario tener el conector SSCC Amazon Redshift configurado de la siguiente manera:

* 'Customized deployment' -> 'Settings' -> 'Classpath'
+
--
** *_Include Crossdata native connector library_*: habilitado.
** *_Include Crossdata native engine library_*: habilitado.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-redshift-0.3_2.12-1.0.x.jar`.
--

* Además, debes subir las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_.

==== Gestión de los secretos

Sube las credenciales de acceso para los _workflows_ y para _Stratio Rocket_ a _Stratio KMS_ tal como aparece descrito en los prerrequisitos.

[#rocket-configuration]

==== Gestión de la configuración: reglas de calidad y linaje

Accede a la configuración de _Stratio Rocket_ en 'Settings' -> 'Governance Lineage' y asegúrate de que la opción "Governance Lineage" esté activada.

Los campos a rellenar son los siguientes:

* _Custom lineage and quality rules methods using JDBC driver_: `com.amazon.redshift.jdbc42.Driver:com.stratio.connectors.ssccredshift.RedshiftQualityRulesAndLineage:getMetadataPath`.
** Con esta opción se activará el linaje para los flujos de datos usando cajas de tipo _datasource_ que accedan directamente al almacén de datos.
+
IMPORTANT: Para que funcione correctamente el linaje, el agente de descubrimiento debe tener como _Service Name_ el valor `<host_redshift>`.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccredshift.RedshiftDriverServiceAccount:com.stratio.connectors.ssccredshift.RedshiftQualityRulesAndLineage:getPlannedQRCreateTable`.
** Con esta opción se soportarán las reglas de calidad planificadas que accedan directamente a tablas del almacén de datos.

NOTE: Recuerda que, si ya tienes más de una referencia en la lista, se deben añadir las siguientes separándolas por una coma.

Reinicia _Stratio Rocket_ para aplicar los cambios.

En las cajas JDBC o de tipo _Spark_ deberás añadir los siguientes atributos extra en las opciones de la tabla:

* _serverType_: `serverless|provisionedCluster`.
* _server_: `<workgroup_name>|<cluster_name>`.

NOTE: Estas variables *no son necesarias* para el linaje y las reglas de calidad sobre tablas virtualizadas en el catálogo.

=== _Stratio Intelligence_

Para la correcta configuración de _Stratio Intelligence_ consulta la xref:amazon-redshift:quick-start-guide.adoc#_stratio_intelligence[sección de _Stratio Intelligence_]. Para la integración con Amazon Redshift, también es necesaria la subida de credenciales mostrada en los prerrequisitos.
