= User guide

== Description

The SSCC Databricks connector allows you to fully integrate Databricks into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:databricks:compatibility-matrix.adoc[compatibility matrix].

== Discover your data

=== Know your data

The discovery performed by the SSCC Databricks agent will make the data hierarchy in Databricks visible and navigable in _Stratio Data Governance_:

* Catalogs
* Tables
* Columns

image::databricks-governance-datastore.png[]

TIP: You can read more about using the data store in the xref:stratio-data-governance:user-manual:from-a-data-store-to-a-dictionary.adoc[_Stratio Data Governance_ user guide].

The agent will also associate technical or system metadata to the levels of the data hierarchy:

. *Data store*, accessible through the "System attributes" button:
+
--
** General
*** _Version_: version of the connector that made the discovery.
*** _URL_: JDBC URL used for connection with Databricks.
*** _Security_: type of security used. Possible values: PAT (_Personal Access Token_) or OAuth2.
--
+
image::databricks-governance-datastore-system-attrs.png[]
+
** Data source attributes: name and version of the database and JDBC driver class used.
+
image::databricks-governance-datastore-system-attrs2.png[]

. *_Table_*, accessible using the "System attributes" button or the "Connector Attributes" link.
** _database_: database where the table is included.
** _schema_: schema where the table is included.
** _table_: table name.
** _format_: file format. Possible values: "delta" and the rest of the formats supported by Databricks and the connector.
** _location_: file location in Databricks.
** _tableType_: table type. Possible values: "TABLE" and "VIEW".
** _delta.minReaderVersion_: minimum supported version of the reading protocol.
** _delta.minWriterVersion_: minimum supported version of the writing protocol.
+
image::databricks-governance-table-system-attrs.png[]

. *_Column_*, accessible using the "System attributes" button or the "Connector Attributes" link, after selecting it from the list.
** Properties (only in _System attributes_): precision, scale and whether the type has a sign.
** Connector attributes: data store type (_DATABRICKS_) and name of the original data type in Databricks.
+
image::databricks-governance-column-system-attrs.png[]

=== BDL virtualization

The connector supports customization of data access in virtualized tables using xref:stratio-data-governance:user-manual:bdl-virtualization.adoc#_bdl_custom_attributes[advanced BDL attributes] from _Stratio Data Governance_. These can be modified from the UI.

* *bdl.options.virtualizer.native*: the possible values are "True" and "False". "True" if the user wants to run queries with the _Stratio Virtualizer_ xref:stratio-virtualizer:user-guide:what-can-i-do-with-stratio-virtualizer.adoc#_supported_data_sources[native dialect]. If this attribute is configured, the default configuration will be overwritten.
* *bdl.options.native.filter*: filter applied on the table virtualization if you carried out discovery with native mode activated or set *bdl.options.virtualizer.native* to "True".

TIP: You can consult how to create attributes in the xref:stratio-data-governance:user-manual:addition-of-metadata[_Stratio Data Governance_ user guide].

TIP: For more details on the use of the BDL, see the xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[BDL data processing documentation].

== Virtualize your data

After tables have been discovered, you can add them to a technical view of a collection. All the configurable parameters of the discovery and those parameters modified from the _Stratio Data Governance_ UI are propagated in the collections where that table is added.

TIP: To learn more about how to manage collections you can consult the xref:stratio-data-governance:user-manual:collections.adoc[_Stratio Data Governance_ user guide].

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

To create a table directly in the _Stratio Virtualizer_ catalog, you can execute the following statements:

* If you want to create the table without native mode:

[source,sql]
----
CREATE TABLE databricks_table USING com.stratio.crossdata.connector.databricks options (
  'url' 'jdbc:databricks://<Server_Hostname>:443/<database>;httpPath=<Http Path>',
  'stratiosecurity' 'true',
  'stratiosecuritymode' 'custom_sscc',
  'stratiocredentials' '<nombre_secreto>',
  'stratiossccdriver' 'com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT',
  'dbtable' '<nombre_tabla>'
)
----

* If you want to create the table with native mode:

[source,sql]
----
CREATE TABLE databricks_table USING jdbc options (
  'url' 'jdbc:databricks://<Server_Hostname>:443/<database>;httpPath=<Http Path>',
  'stratiosecurity' 'true',
  'stratiosecuritymode' 'custom_sscc',
  'stratiocredentials' '<nombre_secreto>',
  'stratiossccdriver' 'com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT',
  'dbtable' '<nombre_tabla>'
)
----

To use Kerberos authentication instead of username/password, replace `com.stratio.connectors.ssccdatabricks.DatabricksDriverPAT` with `com.stratio.connectors.ssccdatabricks.DatabricksDriverOAuth2`.

NOTE: Remember that you need to use a different secret for OAuth2.

== Transform your data

=== _Stratio Rocket_

After the data has been virtualized, you can access it from _Stratio Rocket_ using:

* The catalog.
+
image::databricks-rocket-catalog.png[]

* In the workflows using the input from xref:stratio-rocket:user-guide:workflow-asset/data-inputs.adoc#_stratio_virtualizer[_Stratio Virtualizer_]. You can force access through the native dialect by checking the "Force query execution with native connectors" box.
+
image::databricks-rocket_virtualizer_input.png[]
+
When configuring a _Stratio Rocket_ _workflow_ using a _jdbc_ type box, you must fill in the following optional properties (authentication with OAuth2):

* _oauth2.client.id_: `<oauth2.endpoint_id_databricks>`.
* _oauth2.endpoint_: `<oauth2.endpoint_databricks>`.
* _oauth2.client.secret_: `<oauth2.client.secret_databricks>`.
* _keytab_: `mock1`.
* _principal_: `mock2`.

=== _Stratio Intelligence_

You can see how the data is accessed from _Stratio Intelligence_ in the xref:ROOT:quick-start-guide.adoc#_stratio_intelligence[general quick start guide].
