= Operations guide

== Description

The SSCC Microsoft SQL Server connector allows you to integrate Microsoft SQL Server into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:mssql:compatibility-matrix.adoc[compatibility matrix].

=== Authentication

The connector supports two authentication modes:

* Username/password.
* https://kerberos.org/[Kerberos].

As you'll see later, depending on the mode you choose, specific configuration values and credentials will have to be used in each of the _Stratio Generative AI Data Fabric_ services.

== Prerequisites

. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
IMPORTANT: In the connectors repository, the `sscc-mssql-0.3_2.12-1.5.x` artifact, which will be used for basic use of the Microsoft Server SQL connector, will be available at the URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<artifact_name>`. You need to upload the JDBC driver artifact indicated in the compatibility matrix to the connectors repository. This driver isn't made available.

. The _Stratio KMS_ UI should be accessible to manage credentials:
+
See the section of xref:ROOT:quick-start-guide.adoc[general quick start guide] for the steps you need to take to make it available.

. Have an instance of a Microsoft SQL Server database accessible from the _Stratio Generative AI Data Fabric_ with the chosen authentication mode configured:
+
** A user with the appropriate permissions and their password will be required for basic authentication.
** To configure authentication with https://web.mit.edu/kerberos/kfw-4.1/kfw-4.1/kfw-4.1-help/html/kerberos_terminology.htm[Kerberos] in the platform services, you'll need:
*** The name of the https://web.mit.edu/kerberos/krb5-1.5/krb5-1.5.4/doc/krb5-user/What-is-a-Kerberos-Principal_003f.html[*_service principal_*] and its associated *_realm_*.
*** The Kerberos password.
*** The SPN of the Kerberos server.

. Create secrets in _Stratio KMS_. To do this, go to `https://<stratio_kms_ui_url>/ui/vault/secrets` and create a secret in the corresponding folder of the service with the following options, depending on the authentication mode:
+
--
** Username/password
*** *_user_*: `<microsoft_sql_server_user>`.
*** *_pass_*: `<microsoft_sql_server_password>`.

** Kerberos
*** *_principal_*: `<microsoft_sql_server_service_principal_name>`.
*** *_pass_*: `<kerberos_pass>`.
*** *_spn_*: (SPN of the Kerberos server). It must have the following format: `MSSQLSvc/<FQDN>:<port>@<REALM>`, with FQDN being the server's full domain name.
+
--

This secret must be uploaded to the following _Stratio KMS_ directories:

** *Discovery agent*: `userland/passwords/<agent_name>.<agent_namespace>/<secret_name>`.
** *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<virtualizer_namespace>/<secret_name>`.
** *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Rocket_ workflows*: `userland/passwords/execution-identity-<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Intelligence_*: `/people/passwords/<intelligence_user_name>/<secret_name>`.
+
NOTE: The name and values of the secret for all services must match the ones used to configure the discovery agent.

. Change the Kerberos configuration in the services.
+
For authentication with Kerberos, you need to modify the configuration file used in the service from which authentication is to be initiated, including the Kerberos information used in Microsoft SQL Server.

To modify it, you have to get the Kerberos _ConfigMap_ name, which you can find in '_Stratio Command Center_' -> 'Services' -> '<agent_name>' -> 'Configuration' -> '*_Kerberos configmap name_*'.

image::mssql-cct-configmap.png[]

Once you get the _ConfigMap_ name, you can edit it with a Kubernetes cluster management tool, for example, _kubectl_:

[source,bash]
----
kubectl edit configmap <configmap_name>
----

The file already contains previous information, specific to the service, to which you have to add the Kerberos configuration to access Microsoft SQL Server.

For example, if you have the following configuration of access with Kerberos to Microsoft SQL Server:

. *_Service Principal_*: `connectors/stratio.com@MSSQL.GENERAL.COM`.
. *_Realm_*: `MSSQL.MYCOMPANY.COM`.
. *_KDC host_*: `mssql.mycompany.com:88`.

And the https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html[_krb5.conf_] file of the Configmap_ with the service's previous Kerberos configuration is:

[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
 ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
 }
----

When you change it to accept the Microsoft SQL Server configuration, it would look like this:

[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
  ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
  }
  MYCOMPANY.COM={
   kdc=mssql.mycompany.com:88
   admin_server = mssql.mycompany.com:749
  }
[domain_realm]
 .mycompany.com = MSSQL.MYCOMPANY.COM
 mycompany.com = MSSQL.MYCOMPANY.COM
----

NOTE: You need to restart the service for changes to this configuration to take effect.

== Discover your data

=== Discovery agent

To install a _Stratio Data Governance_ discovery agent for Microsoft SQL Server, in '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS', select "Microsoft SQLServer Agent".

The fields to be filled in for the installation are:

* *_General_*:
** *_Service ID_*: agent's unique identifier. Example: _dg-mssql-agent_.
** *_Service name_*: name displayed in _Stratio KEOS_. Example: _dg-mssql-agent_.
* *_Metadata Datastore (PostgreSQL®)_*
** *_Host_*: the PostgreSQL® instance that stores the discovered metadata. Example: _pgbouncer-postgreskeos-governance.keos-core_.
* *Configuration of the Service to be Discovered*
** *_Service to be discovered_:*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It's the one that will be displayed in the UI. Example: _dg-mssql-agent_.
*** *_Root discovery path_*: Microsoft SQL Server schemas that you want to be discovered. These should be separated by commas, without spaces, and with a slash `/` at the beginning.
+
image::mssql-cct-deployment.png[]

** *_Resource datastore connection configuration_*
*** *_Custom Service URL_*: JDBC URL used to connect to Microsoft SQL Server. Example: `jdbc:sqlserver://mssql.stratio.com:1434/-db-`.
*** *_Mssql Native Mode_*: `(True/False). _True_ if you want to virtualize with the native _Stratio Virtualizer_ connector and _False_ if you want to virtualize without native mode.
*** *_Custom data store service security_*: type of authentication used for the connection: MD5 (username/password) or KRB (Kerberos).
*** *_Access credentials_*: name of the secret created in xref:#create-secret[_Stratio KMS_]. Example: _mssql-secret_.
*** *_SSCC driver location_*: URL where the artifact that will contain the JAR of the SSCC Microsoft SQL Server connector is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
*** *_JDBC driver location_*: URL where the artifact that will contain the JAR of the selected JDBC driver is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar`.
+
image::mssql-cct-deployment2.png[]
+
NOTE: In 'General' -> 'Configuration of the Service to be Discovered' -> 'Filter discovered resources' -> 'Skipped resource paths regular expression (databases)', we recommend entering the value `(.\*sys.*)|(.\*INFORMATION_SCHEMA.*)` to keep the system tables from appearing.

The discovery process is asynchronous. Once the discovery is finished you can view it from the _Stratio Data Governance_ UI.

image::mssql-discover-metadata.png[]

=== _Legacy_ and _path_ modes

There are two discovery modes:

* _Legacy_

Set the _Use legacy mode_ field to "true" to activate _legacy_ mode.

image::mssql-mode-legacy-conf.png[]

* _Path_

Set the _Use legacy mode_ field to "false" to activate _path_ mode.

image::mssql-mode-sscc-conf.png[]

== Virtualize your data

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

=== Eureka agent

To use the BDL, you need to configure the Eureka agent with the Microsoft SQL Server connector. To do this, just add the URL of the connectors repository of the `sscc-mssql-0.3_2.12-1.5.x` artifact in the variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

image::mssql-bdl.png[]

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

TIP: See here for xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[more information about data processing with BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ supports interaction with Microsoft SQL Server through the SSCC Microsoft SQL Server connector. This integration has certain requirements:

* The following _Stratio Virtualizer_ deployment fields must be modified in _Stratio Command Center_. In addition to the URL of the `sscc-mssql-0.3_2.12-1.5.x` artifact, you need to add the URL of the *_jre8_* driver:
+
--
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *JDBC Integration*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
--
+
image::mssql-virtualizer.png[]

== Transform your data

=== _Stratio Rocket_

==== Managing the driver

To use _Stratio Rocket_, the Microsoft SQL Server connector must be configured. To do this:

* You have to add the URL of the `sscc-mssql-0.3_2.12-1.5.x.jar` artifact in the 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` variable of _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/mssql-jdbc-9.4.1.jre8.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-mssql-0.3_2.12-1.5.x.jar`.
+
image::mssql-rocket.png[]

* You also have to upload the access credentials for workflows and for _Stratio Rocket_ to _Stratio KMS_.

IMPORTANT: When using *_legacy_ mode*, you have to add the `lineageMode` variable to "legacy" in the workflows for the old functions to work correctly: quality rules and lineage.

==== Managing secrets

Upload the access credentials for the workflows and for _Stratio Rocket_ to _Stratio KMS_ as described in the prerequisites.

[#rocket-configuration]

==== Configuration management: quality rules and lineage

Go to the _Stratio Rocket_ configuration in 'Settings' -> 'Governance Lineage' and make sure that the "Governance Lineage" option is activated.

The fields to be filled in are the following:

* _Custom lineage and quality rules methods using JDBC driver_: `com.microsoft.sqlserver.jdbc.SQLServerDriver:com.stratio.connectors.ssccmssql.MssqlQualityRulesAndLineage:getMetadataPath`.
** This option activates lineage for data flows using _datasource_ boxes that access the data store directly.
+
IMPORTANT: For lineage to work properly, the discovery agent must have the value `<host_url_jdbc_mssql>.port.<port_url_jdbc_mssql>` as its _Service Name_.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccmssql.MssqlDriverMD5:com.stratio.connectors.ssccmssql.MssqlQualityRulesAndLineage:getPlannedQRCreateTable`.
** With this option, the planned quality rules that directly access tables in the data store will be supported.

NOTE: Remember, if you already have more than one reference in the list, you need to add the following ones, separated by a comma.

Restart _Stratio Rocket_ to apply the changes.

NOTE: These variables are *not necessary* for the lineage and quality rules on virtualized tables in the catalog.

=== _Stratio Intelligence_

To correctly configure _Stratio Intelligence_ with the Microsoft SQL Server connector, you should see the xref:mssql:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section in the quick start guide] remembering to use the appropriate format for the authentication mode for secrets.
