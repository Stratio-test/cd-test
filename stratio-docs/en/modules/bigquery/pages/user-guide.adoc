= User guide

== Description

The SSCC BigQuery connector allows you to fully integrate BigQuery into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:bigquery:compatibility-matrix.adoc[compatibility matrix].

== Discover your data

=== Know your data

In addition to what xref:stratio-data-governance:user-manual:from-a-data-store-to-a-dictionary.adoc#_tables_and_columns[_Stratio Data Governance_] shows, you can also find technical attributes extracted from BigQuery resources. All metadata provided by BigQuery is extracted and added to the _Stratio Data Governance_ UI in both table and column form.

* The metadata extracted in table form are:
+
image:bigquery-table-metadata.png[]

* The metadata extracted in column form are:
+
image:bigquery-column-metadata1.png[]
+
image:bigquery-column-metadata2.png[]

NOTE: Views in BigQuery are supported but are displayed as tables in the _Stratio Data Governance_ UI.

=== BDL virtualization

The discovery process is asynchronous. Once completed, it can be viewed from the _Stratio Data Governance_ UI.

The connector supports customization of data access in virtualized tables using xref:stratio-data-governance:user-manual:bdl-virtualization.adoc#_bdl_custom_attributes[advanced BDL attributes] from _Stratio Data Governance_. These can be modified from the UI.

* *bdl.options.virtualizer.native*: the possible values are "True" and "False". "True" if the user wants to access the data with the xref:stratio-virtualizer:user-guide:what-can-i-do-with-stratio-virtualizer.adoc#_consultas_nativas[native dialect] of _Stratio Virtualizer_. If this attribute is set, the default setting ("True") will be overwritten (in the discovery agent deployment under '_Stratio Command Center_' -> 'General' -> 'Resource datastore connection configuration' -> 'BigQuery Native Mode').
* *bdl.options.native.filter*: filter applied to the virtualization of the table if the data access mode is with the _Stratio Virtualizer_ native dialect or having set *bdl.options.virtualizer.native* to "True".
* *bdl.options.filter*: filter applied on the virtualization of the table if the discovery was performed without native mode enabled.
* *bdl.options.time.travel*: filter applied on the table allowing to select data between time intervals. Full information on the integrated BigQuery functionality can be found at xref:https://cloud.google.com/bigquery/docs/time-travel[official Google documentation].

NOTE: You can consult how to create attributes in the xref:stratio-data-governance:user-manual:addition-of-metadata[_Stratio Data Governance_ user guide].

TIP: For more details on the use of the BDL, see the xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[BDL data processing documentation].

== Virtualize your data

After tables have been discovered, you can add them to a technical view of a collection. All the configurable parameters of the discovery and those parameters modified from the _Stratio Data Governance_ UI are propagated in the collections where that table is added.

TIP: To learn more about how to manage collections you can consult the xref:stratio-data-governance:user-manual:collections.adoc[_Stratio Data Governance_ user guide].

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

To create a table directly in the _Stratio Virtualizer_ catalog, you can execute the following statements:

* If you want to create the table with native mode:
** Normal.
+
[source,sql]
----
CREATE TABLE bigquery_table_nativo USING com.stratio.crossdata.connector.bigquery OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `url` 'jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443;ProjectId=<project_id>;enableSession=1;',
    `dbtable` '<schema_name>.<table_name>'
)
----

** Proxy without authentication.

[source,sql]
----
CREATE TABLE bigquery_table_nativo_proxy_no_auth USING com.stratio.crossdata.connector.bigquery OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `url` 'jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443;ProjectId=<project_id>;enableSession=1;ProxyHost=<proxy_host>;ProxyPort=<proxy_port>;',
    `proxyEnabled` 'true',
    `proxyAddress` 'http://<host>:<port>',
    `project` '<project_id>',
    `dbtable` '<schema_name>.<table_name>',
    `OAuthType` '0',
    `OAuthServiceAcctEmail` '<service_account_name>[@<project_id>.iam.gserviceaccount.com]',
    `OAuthPvtKey` '<json_private_key>'
)
----

** Proxy with authentication.
+
NOTE: In _Stratio Virtualizer_ you *must add* a secret named `bigquery-proxy-secret` with the user and password of the proxy authentication. It does not need to be in Base64. Example: _user: root, pass:1234_.
+
[source,sql]
----
CREATE TABLE bigquery_table_nativo_proxy_auth USING com.stratio.crossdata.connector.bigquery OPTIONS (
    `stratiosecurity` 'false',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `url` 'jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443;ProjectId=<project_id>;enableSession=1;ProxyHost=<proxy_host>;ProxyPort=<proxy_port>;ProxyUid=<proxy_user_auth>;ProxyPwd=<proxy_pass_auth>',
    `proxyEnabled` 'true',
    `proxyAuthEnabled` 'true',
    `proxyAddress` 'http://<host>:<port>',
    `project` '<project_id>',
    `dbtable` '<schema_name>.<table_name>',
    `OAuthType` '0',
    `OAuthServiceAcctEmail` '<service_account_name>[@<project_id>.iam.gserviceaccount.com]',
    `OAuthPvtKey` '<json_private_key>'
)
----

* If you want to create the table without native mode:
** Normal.
+
[source,sql]
----
CREATE TABLE bigquery_table USING bigquery OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `project` '<project_id>',
    `table` '<schema_name>.<table_name>'
)
----

** Proxy without authentication.
+
[source,sql]
----
CREATE TABLE bigquery_table USING bigquery OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `proxyAddress` 'http://<host>:<port>',
    `project` '<project_id>',
    `table` '<schema_name>.<table_name>'
)
----

** Proxy with authentication.
+
NOTE: In _Stratio Virtualizer_ you *must add* a secret named `bigquery-proxy-secret` with the user and password of the proxy authentication. It does not need to be in Base64. Example: _user: root, pass:1234_.
+
[source,sql]
----
CREATE TABLE bigquery_table_proxy_auth USING bigquery OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccbigquery.BigQueryDriver',
    `proxyEnabled` 'true',
    `proxyAuthEnabled` 'true',
    `proxyAddress` 'http://<host>:<port>',
    `project` '<project_id>',
    `table` '<schema_name>.<table_name>'
)
----

== Transform your data

=== _Stratio Rocket_

After the data has been virtualized, you can access it from _Stratio Rocket_ using:

* The catalog.
+
image:bigquery-rocket-catalog.png[]

* In the workflows using the input from xref:stratio-rocket:user-guide:workflow-asset/data-inputs.adoc#_stratio_virtualizer[__Stratio Virtualizer__]. You can force access through the native dialect by checking the "Force query execution with native connectors" box.
+
image:bigquery-rocket-virtualizer-input.png[]

When configuring a _Stratio Rocket_ _workflow_ using a _datasource_ type box, you must fill in the following options:

* _credentials_: `<credentials_bigquery>`.
* _parentProject_: `<parentproject_bigquery>`.
* _dataset_: `<dataset_bigquery>`.
* _table_: `<table_bigquery>`.
* _project_: `<project_bigquery>`.

=== _Stratio Intelligence_

You can see how the data is accessed from _Stratio Intelligence_ in the xref:ROOT:quick-start-guide.adoc#_stratio_intelligence[general quick start guide].
