= Operations guide

== Description

The SSCC ArangoDB connector allows you to integrate ArangoDB into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:arangodb:compatibility-matrix.adoc[compatibility-matrix].

=== Authentication

Currently, the SSCC ArangoDB connector only supports *username and password* authentication.

== Prerequisites

. Have an instance of ArangoDB installed and accessible from _Stratio Generative AI Data Fabric_ with the authentication mode configured.
. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
IMPORTANT: In the connectors repository, the `sscc-arangodb-0.3_2.12-1.2.x` artifact, which will be used for basic use of the SSCC ArangoDB connector, will be available at the URL `http://connectors.tenant-my_namespace/v1/api/artifact/<artifact_name>`.

. The _Stratio KMS_ UI should be accessible to manage credentials:
+
See the section of xref:ROOT:quick-start-guide.adoc[general quick start guide] for the steps you need to take to make it available.
+
TIP: It is not recommended to use users with administrator privileges. Permission management using *permissions* on database is recommended.
+
The user must have _Access_ type permission on the databases and _Read Only_ type permission on the collections to be discovered. If you want to write to ArangoDB from _Stratio Rocket_, the permission to be granted to the collections will be _Read/Write_.
+
image::arangodb-permissions.png[]

. Create secrets in _Stratio KMS_. To do this, go to `https://<stratio_kms_ui_url>/ui/vault/secrets` and create a secret in the corresponding folder of the service with the following options:

* User/password
** *_user_*: <user_arangodb>.
** *_pass_*: <password_arangodb>.

This secret must be uploaded to the following _Stratio KMS_ directories:

* *Discovery agent*: `userland/passwords/<agent_name>.<namespace>/<secret_name>`.
* *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<namespace_virtualizer>/<secret_name>`.
* *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<namespace_rocket>/<secret_name>`.
* *_Stratio Rocket_ _workflows_*: `userland/passwords/execution-identity-<rocket_name>.<namespace_rocket>/<secret_name>`.
* *_Stratio Intelligence_*: `/people/passwords/<intelligence_user_name>/<secret_name>`.
+
NOTE: The name and values of the secret for all services must match the ones used to configure the discovery agent.

--
*If SSL connection is required*

. Create the certificate in _Stratio KMS_. To do this, go to `https://<stratio_kms_ui_url>/ui/vault/secrets` and create a certificate in the corresponding folder of the service with the following options:
+
** *_arangodb-ssl_crt_*: `<arangodb_ssl_certificate>`.
+
image::arangodb-certificate-ssl.png[]
+
This certificado should be uploaded to the following _Stratio KMS_ directories:
+
** *Discovery agent*: `userland/certificates/<agent_name>`.
** *_Stratio Virtualizer_*: `userland/certificates/<virtualizer_name>.<namespace_virtualizer>`.
** *_Stratio Rocket_*: `userland/certificates/<rocket_name>.<namespace_rocket>`.
** *_Stratio Rocket_ _workflows_: `userland/certificates/execution-identity-<namespace_rocket>.<namespace_rocket>`.
** *_Stratio Intelligence_*: `/people/people/certificates/<intelligence_user_name>`.
--

== Discover your data

=== Discovery agent

To install a _Stratio Data Governance_ discovery agent for ArangoDB you must go to '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors NoSQL' and select "ArangoDB Agent".

The fields to be filled in for the installation are:

* *_General_*:
** *_Service ID_*: agent's unique identifier. Example: _dg-arangodb-agent_.
** *_Name of the Service_*: name displayed in _Stratio KEOS_.
* *_Metadata Datastore (PostgreSQL®)_*
** *_Host_*: the PostgreSQL® instance that stores the discovered metadata. Example: _poolpostgresgov_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It's the one that will be displayed in the UI.
*** *_Root discovery path_*: collection to be discovered. Example: _/connectorstorage_.
** *_Resource datastore connection configuration_*
*** *_Custom Service URL_*: the URL where the ArangoDB instance is hosted. Example: _arangoDbHost:8529_.
*** *_Access credentials_*: name of the secret created in xref:#create-secret[_Stratio KMS_]. Example: _arangodb-secret_.
*** *_Datastore driver location_*: URL where the artifact that will contain the JAR of the SSCC ArangoDB connector is located in the connectors repository.
*** *_Service security SSL Enabled_*: `(True/False)`. Indicates if the ArangoDB instance uses SSL connection.
* *_ArangoDB Settings_*
** *_ArangoDB Document Sample Size_*: number of documents that are extracted to infer the collection schema.

image::arangodb-cct-deployment1.png[]

image::arangodb-cct-deployment2.png[]

image::arangodb-cct-deployment3.png[]

The discovery process is asynchronous. Once the discovery is finished you can view it from the _Stratio Data Governance_ UI.

image::arangodb-governance.png[]

image::arangodb-metadata1.png[]

== Virtualize your data

IMPORTANT: Note that, to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

=== Eureka Agent

To use the BDL, you need to configure the Eureka agent with the SSCC ArangoDB connector. To do this, simply add the URL of the connectors repository `sscc-arangodb-0.3_2.12-1.2.x` artifact in the '_Stratio Command Center_' -> 'Customized deployment' -> 'Settings' -> `Additional jars` variable.

image::arangodb-bdl.png[]

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

TIP: See here xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[more information about data processing with BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ supports interaction with ArangoDB through the SSCC ArangoDB connector. This integration has certain requirements:

* The following _Stratio Virtualizer_ deployment fields must be modified in _Stratio Command Center_:
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `(True/False)`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.tenant-my_namespace/v1/api/artifact/sscc-arangodb-0.3_2.12-1.2.x.jar`.
+
image::arangodb-virtualizer-conf.png[]

== Transform your data

=== _Stratio Rocket_

==== Managing the driver

To use _Stratio Rocket_, the SSCC ArangoDB connector must be configured. To do this:

* You have to add the URL of the `sscc-arangodb-0.3_2.12-1.2.x` artifact in the 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` variable of _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.tenant-my_namespace/v1/api/artifact/sscc-arangodb-0.3_2.12-1.2.x.jar`.
+
image::arangodb-rocket-conf.png[]

==== Managing secrets

Upload the access credentials for the _workflows_ and for _Stratio Rocket_ to _Stratio KMS_ as described in the prerequisites.

[#rocket-configuration]

==== Configuration management: quality rules and lineage

Access the _Stratio Rocket_ configuration in 'Settings' -> 'Governance Lineage' and make sure that the "Governance Lineage" option is enabled.

The fields to be filled in are the following:

* _Custom lineage and quality rules methods using Spark format_: `com.stratio.connectors.ssccarangodb:com.stratio.connectors.ssccarangodb.ArangoDBQualityRulesAndLineage:getMetadataPath`.
** This option activates lineage for data flows using _datasource_ boxes that access the data store directly.
+
IMPORTANT: For lineage to work properly, the discovery agent must have the value `<host_url_arangodb>.port.<port_url_arangodb>` as its _Service Name_.

* _Custom planned quality rules methods_: `com.stratio.connectors.ssccarangodb.ArangoDBDriver:com.stratio.connectors.ssccarangodb.ArangoDBQualityRulesAndLineage:getPlannedQRCreateTable`.
** With this option, the planned quality rules that directly access tables in the data store will be supported.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

Restart _Stratio Rocket_ to apply the changes.

NOTE: These variables are *not necessary* for lineage and quality rules on virtualized tables in the catalog.

=== _Stratio Intelligence_

To correctly configure _Stratio Intelligence_, see the xref:arangodb:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section]. For integration with ArangoDB, only the credentials shown in the prerequisites need to be uploaded.
