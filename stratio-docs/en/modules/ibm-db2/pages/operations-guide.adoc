= Operations guide

== Description

The SSCC IBM Db2 connector allows you to integrate IBM Db2 into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:ibm-db2:compatibility-matrix.adoc[compatibility matrix].

=== Authentication

Currently, the connector only supports *username and password* authentication.

== Prerequisites

. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
IMPORTANT: In the connectors repository, the `sscc-db2-0.3_2.12-1.4.x` and `jcc-11.5.0.0.jar` artifacts, which will be used for basic use of the SSCC IBM Db2 connector, will be available at the URL `http://connectors.tenant-my_namespace/v1/api/artifact/<artifact_name>`. This driver isn't included in the repository by default.

. The _Stratio KMS_ UI should be accessible to manage credentials:
+
See the section of xref:ROOT:quick-start-guide.adoc[general quick start guide] for the steps you need to take to make it available.

. Have an instance of an IBM Db2 database accessible from the _Stratio Generative AI Data Fabric_ with the authentication mode configured:
+
** It is recommended to use five different users with username and password:
+
--
*** user_governance_db2
*** user_virtualizer_db2
*** user_rocket_db2
*** user_rocket_execution_db2
*** user_virtualizer_db2
--
+
** The use of users with administrator privileges is not recommended.
** Once the users are created, minimal permissions are required by the _Stratio Generative AI Data Fabric_ platform.
** Permission management using *privileges* on database is recommended. The 5 user types need to have the *DATAACCESS* role over the database so that they can perform the operations the connector requires.

. Create secrets in _Stratio KMS_. Currently, the connector only supports username and password authentication.
+
--
The secret to be uploaded consists of two keys:

** _user_: <db2_user>.
** _pass_: <db2_pass>.
--
+
This secret must be uploaded to the following _Stratio KMS_ directories:
+
** *Discovery agent*: `userland/passwords/<agent_name>/<secret_name>`.
** *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<virtualizer_namespace>/<secret_name>`.
** *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Rocket_ _workflows_*: `userland/passwords/execution-identity-<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Intelligence_*: `/people/passwords/<intelligence_user_name>/<secret_name>`.

== Discover your data

=== Discovery agent

To install a _Stratio Data Governance_ discovery agent for IBM Db2, go to '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS' and select the agent "IBM Db2 Agent".

The fields to be filled in for the installation are:

* *_General_*
** *_Service ID_*: agent's unique identifier.
** *_Service name_*: name displayed in _Stratio KEOS_. Example: _dg-db2-agent_.
* *Metadata Datastore (PostgreSQL®)*
** *_Host_*: the PostgreSQL® instance that stores the discovered metadata. For example: _pgbouncer-postgreskeos-governance.keos-core_.
* *Configuration of the Service to be Discovered*
** *Service to be discovered:*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It's the one that will be displayed in the UI. Example: _dg-db2-agent_.
*** *_Root discovery path_*: IBM Db2 databases that you want to be discovered. They should be separated by commas, without spaces, and with a slash `/` at the beginning.

** *Resource datastore connection configuration*
*** *_Custom Service URL_*: URL JDBC to the IBM Db2 database. Example: `jdbc:db2://your.host.com:50000/-db-`.
*** *_Access credentials_*: name of the secret created in xref:#_secrets_management[_Stratio KMS_]. Example: _db2-secret_.
*** *_SSCC driver location_*: URL where the artifact that will contain the JAR of the IBM Db2 SSCC connector is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.4.x.jar`.
*** *_JDBC driver location_*: URL where the artifact that will contain the JAR of the selected JDBC driver is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/jcc-11.5.0.0.jar`.

The discovery process is asynchronous. Once the discovery is finished you can view it from the _Stratio Data Governance_ UI.

== Virtualize your data

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

=== _Legacy_ and _path_ modes

There are two discovery modes:

* _Legacy_

image::db2-mode-legacy-dictionary.png[]

Set the _Use legacy mode_ field to "true" to activate _legacy_ mode.

image::db2-mode-legacy-conf.png[]

* _Path_. It has 3 levels: database, schema and table.

image::db2-mode-sscc-dictionary.png[]

Set the _Use legacy mode_ field to "false" to activate _path_ mode.

image::db2-mode-sscc-conf-basic.png[]

=== Eureka agent

To use the BDL, you need to configure the Eureka agent with the SSCC IBM Db2 connector. To do this, just add the URL of the connectors repository of the `sscc-db2-0.3_2.12-1.4.x` artifact in the variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

TIP: See here xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[more information about data processing with BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ supports interaction with IBM Db2 through the SSCC IBM Db2 connector. This integration has certain requirements:

* The following _Stratio Virtualizer_ deployment fields must be modified in _Stratio Command Center_:
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `(True/False)`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.0.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/jcc-11.5.0.0.jar`.

== Transform your data

=== _Stratio Rocket_

==== Managing the driver

To use _Stratio Rocket_, the SSCC IBM Db2 connector must be configured. To do this:

* You have to add the URL of the `sscc-db2-0.3_2.12-1.4.x` artifact in the 'Customized deployment' -> 'Settings' -> 'Classpath configuration' -> `Rocket extra jars` variable of _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.4.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/jcc-11.5.0.0.jar`.

* You also have to upload the access credentials for _workflows_ and for _Stratio Rocket_ to _Stratio KMS_.

==== Managing secrets

Upload the access credentials for the _workflows_ and for _Stratio Rocket_ to _Stratio KMS_ as described in the prerequisites.

[#rocket-configuration]

==== Configuration management: quality rules and lineage

Access the _Stratio Rocket_ configuration in 'Settings' -> 'Governance Lineage' and make sure that the "Governance Lineage" option is enabled.

The fields to be filled in are the following:

* _Custom lineage and quality rules methods using JDBC driver_: `com.ibm.db2.jcc.DB2Driver:com.stratio.connectors.ssccdb2.Db2QualityRulesAndLineage:getMetadataPath`.
** This option activates lineage for data flows using _datasource_ boxes that access the data store directly.
+
IMPORTANT: For lineage to work properly, the discovery agent must have the value `<host_url_jdbc_db2>.port.<port_url_jdbc_db2>` as its _Service Name_.
+
IMPORTANT: When using the _legacy_ mode, you must add in the workflows the variable `lineageMode` to `legacy` for the old functionalities to work correctly: quality rules and lineage.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccdb2.Db2DriverMD5:com.stratio.connectors.ssccdb2.Db2QualityRulesAndLineage:getPlannedQRCreateTable`.
** With this option, the planned quality rules that directly access tables in the data store will be supported.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

Restart _Stratio Rocket_ to apply the changes.

NOTE: These variables are *not necessary* for lineage and quality rules.

=== _Stratio Intelligence_

To correctly configure _Stratio Intelligence_, see the xref:ibm-db2:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section]. For integration with IBM Db2, only the credentials shown in the prerequisites need to be uploaded.
