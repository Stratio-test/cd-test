= Operations guide

== Description

The SSCC AS400 connector allows you to integrate IBM Db2 iSeries AS400 in _Stratio Generative AI Data Fabric_

Both the supported features and the different versions are found in the xref:as400:compatibility-matrix.adoc[compatibility matrix].

=== Authentication

Currently, the connector only supports *username and password* authentication.

== Prerequisites

. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
IMPORTANT: In the connectors repository, the `sscc-db2-0.3_2.12-1.4.x` and `jt400-11.1.jar` artifacts, which will be used for basic use of the SSCC AS400 connector, will be available at the URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<artifact_name>`. You need to upload the JDBC driver artifact indicated in the compatibility matrix to the connectors repository. This driver isn't included in the repository by default.

. The _Stratio KMS_ UI should be accessible to manage credentials:

. Have an instance of an IBM Db2 iSeries AS400 database accessible from the _Stratio Generative AI Data Fabric_ with the chosen authentication mode configured:

** It is recommended to use five different users with username and password:
+
--
*** user_governance_as400
*** user_virtualizer_as400
*** user_rocket_as400
*** user_rocket_execution_as400
*** user_virtualizer_as400
--
+
** The use of users with administrator privileges is not recommended.
** Once the users are created, minimal permissions are required by the _Stratio Generative AI Data Fabric_ platform.
** Permission management using *privileges* on the schemas is recommended. The 5 user types must have the *CREATEIN* privilege on the corresponding schemas so that they can perform the operations the connector requires.

. Create the secrets in _Stratio KMS_. Currently, the connector only supports username and password authentication.
+
--
The secret to be uploaded consists of two keys:

* _user_: <as400_user>
* _pass_: <as400_password>
--
+
This secret must be uploaded to the following _Stratio KMS_ directories:

** *Discovery agent*: `userland/passwords/<agent_name>/<secret_name>`.
** *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<virtualizer_namespace>/<secret_name>`.
** *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Rocket_ workflows*: `userland/passwords/execution-identity-<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Intelligence_*: `/people/passwords/<intelligence_user_name>/<secret_name>`.

== Discover your data

=== Discovery agent

To install the _Stratio Data Governance_ discovery agent for IBM Db2 iSeries AS400, you must select "AS400 Agent" in '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS'.

The fields to be filled in for the installation are:

* *_General_*:
** *_Service ID_*: discovery agent's unique identifier. Example: _dg-as400-agent_.
** *_Name of the Service_*: name displayed in _Stratio KEOS_. Example: _dg-as400-agent_.
* *_Metadata Data store (PostgreSQL®)_*
** *_Host_*: PostgreSQL® instance storing the discovered metadata. Example: _pgbouncer-postgreskeos-governance.keos-core_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It's the one that will be displayed in the UI. Example: _dg-as400-agent_.
*** *_Root discovery path_*: IBM Db2 iSeries AS400 databases you want to be discovered. They should be separated by commas, without spaces, and with a slash `/` at the beginning.

** *Resource datastore connection configuration*
*** *_Custom Service URL_*: JDBC URL used to connect to IBM Db2 iSeries AS400. Example: `jdbc:as400://your.host.com/-db-;prompt=false;`.
IMPORTANT: For the correct operation of the agent the JDBC URL must contain the suffix `/-db-` and the parameters `prompt=false` and `naming=sql`.
*** *_Access credentials_*: name of the secret created in xref:#_secrets_management[_Stratio KMS_]. Example: _as400-secret_.
*** *_SSCC driver location_*: URL where the artifact that will contain the JAR of the AS400 SSCC connector is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.4.x.jar`.
*** *_JDBC driver location_*: URL where the artifact that will contain the JAR of the selected JDBC driver is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/v1/api/artifact/jt400-11.1.jar`.

The discovery process is asynchronous. Once the discovery is finished you can view it from the _Stratio Data Governance_ UI.

=== _Legacy_ and _path_ modes

There are two discovery modes:

* _Legacy_

image::as400-mode-legacy-dictionary.png[]

Set the _Use legacy mode_ field to "true" to activate it.

image::as400-mode-legacy-conf.png[]

* _Path_. It has 3 levels: database, schema and table.

image::as400-mode-sscc-dictionary.png[]

Set the _Use legacy mode_ field to "false" to activate it.

image::as400-mode-sscc-conf-basic.png[]

== Virtualize your data

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

=== Eureka agent

To use the BDL, you need to configure the Eureka agent with the Oracle connector. To do this, just add the URL of the connectors repository of the `sscc-as400-0.3_2.12-1.0.x` artifact in the variable 'Customized deployment' -> 'Settings' -> `Additional jars`.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

TIP: See here for xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[more information about data processing with BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ supports interaction with IBM Db2 iSeries AS400 through the SSCC AS400 connector. This integration has certain requirements:

* The following _Stratio Virtualizer_ deployment fields must be modified in _Stratio Command Center_:
* 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `(True/False)`.
* 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.4.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/jt400-11.1.jar`.

== Transform your data

=== _Stratio Rocket_

==== Managing the driver

To use _Stratio Rocket_, the SSCC AS400 connector needs to be configured. To do this:

* You have to add the URL of the `sscc-db2-0.3_2.12-1.4.x` artifact in the 'Customized deployment' -> 'Settings' -> 'Classpath configuration' -> `Rocket extra jars` variable of _Stratio Command Center_.
** *_Rocket extra jars_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-db2-0.3_2.12-1.4.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/jt400-11.1.jar`.

==== Managing secrets

Upload the access credentials for the _workflows_ and for _Stratio Rocket_ to _Stratio KMS_ as described in the prerequisites.

[#rocket-configuration]

==== Configuration management: quality rules and lineage

Go to the _Stratio Rocket_ configuration in 'Settings' -> 'Governance Lineage' and make sure that the "Governance Lineage" option is enabled.

The fields to be filled in are the following:

* _Custom lineage and quality rules methods using JDBC driver_: `com.ibm.as400.access.AS400JDBCDriver:com.stratio.connectors.ssccas400.As400QualityRulesAndLineage:getMetadataPath`.
** This option activates lineage for data flows using _datasource_ boxes that access the data store directly.
+
IMPORTANT: For lineage to work properly, the discovery agent must have the value `<host_url_jdbc_as400>.port.<port_url_jdbc_as400>` as its _Service Name_.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccas400.As400DriverMD5:com.stratio.connectors.ssccas400.As400QualityRulesAndLineage:getPlannedQRCreateTable`.
** With this option, the planned quality rules that directly access tables in the data store will be supported.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

Restart _Stratio Rocket_ to apply the changes.

NOTE: These variables are *not necessary* for lineage and quality rules on virtualized tables in the catalog.

=== _Stratio Intelligence_

To correctly configure _Stratio Intelligence_, see the xref:as400:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section]. For  integration with IBM Db2 iSeries AS400, only the credentials shown in the prerequisites need to be uploaded.
