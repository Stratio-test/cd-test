= Operations guide

== Description

The SSCC SAP HANA connector allows you to integrate SAP HANA in _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:saphana:compatibility-matrix.adoc[compatibility matrix].

=== Authentication

Currently, the connector only supports *username and password* authentication.

As will be seen below, specific configuration values and credentials will have to be used in each of the _Stratio Generative AI Data Fabric_ services.

== Prerequisites

. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
See the section of the xref:connectors-repository:operations-guide.adoc#_installation[operations guide] to find out how to install the repository.
+
IMPORTANT: In the connectors repository, the `sscc-saphana-0.3_2.12-1.1.x` artifact, which will be used for basic use of the SAP HANA connector, will be available at the URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<artifact_name>`. You need to upload the JDBC driver artifact indicated in the compatibility matrix to the connectors repository. This driver isn't included in the repository by default.

. The _Stratio KMS_ UI should be accessible to manage credentials:
+
See the section on the xref:ROOT:quick-start-guide.adoc#access-kms-ui[_Stratio KMS_ UI] for the steps you need to take to make it available.

. Create secrets in _Stratio KMS_. To do this, go to `https://<stratio_kms_ui_url>/ui/vault/secrets` and create a secret in the corresponding folder of the service with the following options, depending on the authentication mode:
+
** Username/Password
*** *_user_*: `<saphana_user>`.
*** *_pass_*: `<saphana_password>`.
+
This secret must be uploaded to the following _Stratio KMS_ directories:
+
**** *Discovery agent*: `userland/passwords/<agent name>.<namespace>/<secret_name>`.
**** *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<virtualizer_namespace>/<secret_name>`.
**** *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<rocket_name>/<secret_name>`.
**** *_Stratio Rocket_ workflows*: `userland/passwords/execution-identity-<rocket_name>.<rocket_namespace>/<secret_name>`.
**** *_Stratio Intelligence_*: `people/certificates/<intelligence_username>`.
+
NOTE: The name and values of the secret for all services must match the ones used to configure the discovery agent. It is recommended to profile the database access user for this secret.

== Discover your data

=== Discovery agent

To install a _Stratio Data Governance_ discovery agent for SAP HANA you must select "SAP HANA Agent" in '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors Data Warehouse'.

The fields to be filled in for the installation are:

* *_General_*
** *_Service ID_*: agent's unique identifier. Example: _dg-saphana-agent_.
** *_Service name_*: name displayed in _Stratio KEOS_. Example: _dg-saphana-agent_.
* *_Metadata Datastore (PostgreSQL®)_*
** *_Host_*: the PostgreSQL® instance that stores the discovered metadata. Example: _pgbouncer-postgreskeos-governance.keos-core_.
* *_Configuration of the service to be discovered_*
** *_Service to be discovered_*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It's the one that will be displayed in the UI. Example: _dg-saphana-agent_.
*** *_Root discovery path_*: SAP HANA databases you want to be discovered. These should be separated by commas, without spaces, and with a slash `/` at the beginning.
+
image::saphana-cct-deployment1.png[]

** *Resource datastore connection configuration*
*** *_Custom Service URL_*: JDBC URL used to connect to SAP HANA. Example: `jdbc:sap://sap.hana.stratio.com:39041/-db-`. The end of the string must contain the suffix `/-db-`.
*** *_Custom data store service security_*: only supports username and password (MD5).
*** *_Access credentials_*: name of the secret in _Stratio KMS_. Example: _saphana-secret_.
*** *_SSCC driver location_*: URL where the artifact that will contain the JAR of the SSCC SAP HANA connector is located in the connectors repository. Example: _http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-saphana-0.3_2.12-1.1.x.jar_.
*** *_JDBC driver location_*: URL where the artifact that will contain the JAR of the selected JDBC driver is located in the connectors repository. Example: _http://connectors.<tenant>-<namespace>/v1/api/artifact/ngdbc-2.15.10.jar_.
*** *_SAP HANA arrays discovery enabled_*: SAP HANA JDBC agent does not support arrays. The SAP HANA discovery agent is able to discover arrays if this option is enabled. Arrays are not supported in virtualization.
+
image::saphana-cct-deployment2.png[]
+
image::saphana-cct-deployment3.png[]

The discovery process is asynchronous. Once completed, it can be viewed from the _Stratio Data Governance_ UI.

image::saphana-discover-metadata.png[]

== Virtualize your data

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

NOTE: Arrays are not supported in virtualization.

NOTE: Spatial data types such as _st++_++geometry_ and _st++_++point_ are considered as _binary_ types to enable virtualization.

=== _Legacy_ and _path_ modes

There are two discovery modes:

* _Legacy_

image::saphana-mode-legacy-dictionary.png[]

Set the _Use legacy mode_ field to "true" to activate it.

image::saphana-mode-legacy-conf.png[]

* _Path_. It has 3 levels: database, schema and table.

image::saphana-mode-sscc-dictionary.png[]

Set the _Use legacy mode_ field to "false" to activate it.

image::saphana-mode-sscc-conf-include.png[]

The following image is used to avoid a schema. In this case, all the ones in the database system itself will be avoided.

image::saphana-mode-sscc-conf-skip.png[]

=== Eureka agent

To use the BDL, you need to configure the Eureka agent with the SAP HANA connector. To do this, just add the URL of the connectors repository of the `sscc-saphana-0.3_2.12-1.1.x` artifact in the 'Customized deployment' -> 'Settings' -> `Additional jars` variable.

image::saphana-bdl.png[]

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

TIP: See here xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[more information about data processing with BDL].

=== _Stratio Virtualizer_

_Stratio Virtualizer_ supports interaction with SAP HANA through the SSCC SAP HANA connector. This integration has certain requirements:

* The following _Stratio Virtualizer_ deployment fields must be modified in _Stratio Command Center_. In addition to the `sscc-saphana-0.3_2.12-1.1.x` artifact URLs, you need to add the driver *_ngdbc_* URL:
+
--
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Integration'.
*** *_JDBC Integration_*: `True`.
** 'Customized deployment' -> 'Environment' -> 'External datastores' -> 'JDBC Drivers URL List'.
*** *_JDBC Drivers URL List_*: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-saphana-0.3_2.12-1.1.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/ngdbc-2.15.10.jar`.
--
+
image::saphana-virtualizer-conf.png[]

== Transform your data

=== _Stratio Rocket_

==== Managing the driver

For the connector to work, the SAP HANA dependencies must be added to the _classpath_.

In addition to the URL of the `sscc-saphana-0.3_2.12-1.1.x` artifact, the URL of the *_ngdbc_* driver needs to be added. You need to configure _Stratio Rocket_ as follows:

* 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars`: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-saphana-0.3_2.12-1.1.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/ojdbc8.jar`.
+
image::saphana-rocket-conf.png[]

* You also have to upload the access credentials for workflows and for _Stratio Rocket_ to _Stratio KMS_.

IMPORTANT: When using *_legacy_ mode*, you have to add the `lineageMode` variable to "legacy" in the workflows for the old functions to work correctly: quality rules and lineage.

==== Managing secrets

Upload the access credentials for the workflows and for _Stratio Rocket_ to _Stratio KMS_ as described in the prerequisites.

==== Configuration management: quality rules and lineage

Go to the _Stratio Rocket_ configuration in 'Settings' -> 'Governance Lineage' and make sure that the "Governance Lineage" option is activated.

The fields to be filled in are the following:

* _Custom lineage and quality rules methods using JDBC driver_: `com.sap.db.jdbc.Driver:com.stratio.connectors.ssccsaphana.SapHanaDriverQualityRulesAndLineage:getMetadataPath`.
** This option activates lineage for data flows using _datasource_ boxes that access the data store directly.
+
IMPORTANT: For lineage to work properly, the discovery agent must have the value `<host_url_jdbc_saphana>.port.<port_url_jdbc_saphana>` as its _Service Name_.
+
* _Custom planned quality rules methods_: `com.stratio.connectors.ssccsaphana.SapHanaDriver:com.stratio.connectors.ssccsaphana.SapHanaDriverQualityRulesAndLineage:getPlannedQRCreateTable`.
** With this option, the planned quality rules that directly access tables in the data store will be supported.

NOTE: Remember, if you already have more than one reference in the list, you need to add the following ones, separated by a comma.

Restart _Stratio Rocket_ to apply the changes.

NOTE: These variables are *not necessary* for the lineage and quality rules on virtualized tables in the catalog.

=== _Stratio Intelligence_

To correctly configure _Stratio Intelligence_, see the xref:saphana:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section]. For integration with SAP HANA, you only need to upload the credentials shown in the prerequisites.
