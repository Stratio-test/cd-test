= Operations guide

== Description

The AWS IoT connector allows you to integrate AWS IoT into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:aws-iot:compatibility-matrix.adoc[compatibility matrix].

NOTE: This connector is integrated in the _Stratio Rocket_ module within the _Stratio Generative AI Data Fabric_.

=== Authentication

Currently, the AWS IoT connector supports the *certificate and private key authentication method*.

== Prerequisites

* Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
IMPORTANT: In the connectors repository, the artifact `custom-aws-iot-1.0.x` used in this guide will be available at URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<artifact_name>`.

* The xref:ROOT:quick-start-guide.adoc#access-kms-ui[_Stratio KMS_ UI] should be accessible to manage credentials.
* Have an instance of an AWS IoT namespace configured and accessible from the _Stratio Generative AI Data Fabric_.
* Create secrets in _Stratio KMS_.
+
--
*Certificate*

The secret to be uploaded consists of two keys:

* _user_: `<private-key>`.
* _pass_: `<certificate>`.
--
+
Configure the following variables in the deployment
+
[source,yml]
----
- name: SPARK_SECURITY_DB_ENABLE
  value: "true"
- name: SPARK_SECURITY_DB_<secret-name>_VAULT_PATH
  value: /v1/userland/passwords/<tenant>-<secret-name>
----
+
Here is an example of how the environment variable and _workflow_ property names have to look like to match.
+
image::mqtt-pass-deploy.png[]
+
That value must not contain any `_` to differentiate the secrets. For example:
+
** `SPARK_SECURITY_DB_MQTT_DES_VAULT_PATH`: invalid.
** `SPARK_SECURITY_DB_MQTTDES_VAULT_PATH`: valid.
+
[TIP]
====
You get an image similar to this:

image::mqtt-vault-execution-user-pass.png[]

====

== Permissions

You have to configure the associated permissions to be able to read from the MQTT topic.

Below is an example of the basic permissions, although you should ideally use the minimum necessary.

[source,json]
----
{
 "Version": "2012-10-17",
 "Statement": [
   {
     "Effect": "Allow",
     "Action": [
       "iot:Publish",
       "iot:Receive"
     ],
     "Resource": "arn:aws:iot:eu-west-3:268367799918:topic/sdk/test/java"
   },
   {
     "Effect": "Allow",
     "Action": "iot:Subscribe",
     "Resource": "arn:aws:iot:eu-west-3:268367799918:topicfilter/sdk/test/java"
},
   {
     "Effect": "Allow",
     "Action": "iot:Connect",
     "Resource": [
       "arn:aws:iot:eu-west-3:268367799918:client/sdk-java",
       "arn:aws:iot:eu-west-3:268367799918:client/rocket"
     ]
   },
   {
     "Effect": "Allow",
     "Action": "iot:Publish",
     "Resource": "arn:aws:iot:eu-west-3:268367799918:client/sdk-java"
   },
   {
     "Effect": "Allow",
     "Action": "iot:Receive",
     "Resource": "arn:aws:iot:eu-west-3:268367799918:client/sdk-java"
   },
   {
     "Effect": "Allow",
     "Action": "iot:Subscribe",
     "Resource": "arn:aws:iot:eu-west-3:268367799918:client/sdk-java"
   }
 ]
}
----
