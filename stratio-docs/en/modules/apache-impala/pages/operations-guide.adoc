= Operations guide

== Description

The SSCC Apache Impala® connector allows you to integrate SSCC Apache Impala® into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:apache-impala:compatibility-matrix.adoc[compatibility matrix].

=== Authentication

Currently, the connector only supports *https://kerberos.org/[Kerberos] authentication*.

== Prerequisites

. Have an instance of an Apache Impala® database accessible from the _Stratio Generative AI Data Fabric_ with the chosen authentication mode configured:
+
** To configure authentication with Kerberos in the platform services, you'll need:
*** The name of the *_service principal_* and its associated *_realm_*.
*** The *_keytab_* with the encrypted keys encoded in Base64 associated with the *_service principal_*.
*** The URLs of the *Admin* and *KDC* servers used.

. Have a JDBC URL for the connection to the Apache Impala® server.

** You can read more about the format of this URL in the https://impala.apache.org/docs/build/html/topics/impala_jdbc.html[official documentation].
** In the examples _jdbc:hive2://impala.labs.stratio.com:21050/default_ is used.
** You can add special attributes for your database connection to the URL if you need them, separated by `;` with the format `property=value`, but never put the user and password attributes. The final suffix `/-db-` is platform specific and must always be added.
** The JDBC connection string must have this format: `jdbc:hive2://<host>:<port>/-db-`. Only the host and port should be changed.

. Install the xref:connectors-repository:operations-guide.adoc#_installation[connectors repository].
+
See the xref:connectors-repository:operations-guide.adoc#_installation[operations guide] to find out how to install the repository.
+
NOTE: In the connectors repository, the `sscc-hive-0.3_2.12-1.5.x.jar` and `hive-jdbc-3.1.2-1.0.x.jar` artifacts will be available at the URL `http://connectors.<tenant>-<namespace>/v1/api/artifact/<artifact_name>`.

. You need to have 5 different users (one for each module):

The connection is established through a database, so every user must have specific roles. The following table lists the users with the roles required for the platform to work.
+
|===
|Username |Apache Impala® privileges

| `user_governance_impala`
| CREATE, REFRESH and SELECT

| `user_virtualizer_impala`
| INSERT, CREATE, REFRESH and SELECT

| `user_rocket_mssql`
| INSERT, CREATE, REFRESH and SELECT

| `user_rocket_execution_impala`
| INSERT, CREATE, REFRESH and SELECT

| `user_intelligence_impala`
| INSERT, CREATE, REFRESH and SELECT
|===
+
This is an example of how to do it:
+
[source,sql]
----
GRANT CREATE,REFRESH,SELECT ON database your_database
   TO USER user_governance_impala
----

. The _Stratio KMS_ UI should be accessible to manage credentials:
+
See the section on the xref:ROOT:quick-start-guide.adoc[_Stratio KMS_ UI] for the steps you need to take to make it available.

[#create-secret]

. Create secrets in _Stratio KMS_. To do this, go to `https://<stratio_kms_ui_url>/ui/vault/secrets` and create a secret in the corresponding folder of the service with the following options:
+
Each user must be integrated with each Stratio module. When inserting secrets, all of them (without exception) must have the same format:
+
--
** Kerberos
*** *_principal_*: `<hive_service_principal_name>`.
*** *_keytab_*: `<hive_keytab_base64>`.
--
+
This secret must be uploaded to the following _Stratio KMS_ directories:

** *Discovery agent*: `userland/passwords/<agent_name>.<agent_namespace>/<secret_name>`.
** *_Stratio Virtualizer_*: `userland/passwords/<virtualizer_name>.<virtualizer_namespace>/<secret_name>`.
** *_Stratio Rocket_*: `userland/passwords/<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Rocket_ workflows*: `userland/passwords/execution-identity-<rocket_name>.<rocket_namespace>/<secret_name>`.
** *_Stratio Intelligence_*: `/people/passwords/<intelligence_user_name>/<secret_name>`.
+
NOTE: The name and values of the secret for all services must match the ones used to configure the discovery agent.

. Change the Kerberos configuration in the services.
+
For authentication with Kerberos, you need to modify the configuration file used in the service from which authentication is to be initiated, including the Kerberos information used in Apache Impala®.
+
--
To modify it, you have to get the name of the Kerberos _ConfigMap_, which can be found in the service configuration view in '_Stratio Command Center_' → 'Services' → '<agent_name>' → 'Configuration' → '_Kerberos configmap name_'. 

Once you get the _ConfigMap_ name, you can edit it with a Kubernetes cluster management tool, for example, _kubectl_:
+
[source,bash]
----
kubectl edit configmap <configmap_name>
----
+
The file already contains previous information, specific to the service, to which you have to add the Kerberos configuration to access Apache Impala®.
+
For example, if you have the following configuration of access with Kerberos to Apache Impala®:
+
* _Service Principal_: `myprincipal/impala.mycompany.com`.
* _Realm_: `MYCOMPANY.COM`.
* _KDC host_: `impala.mycompany.com:88`.
* _Admin host_: `impala.mycompany.com:749`.
+
And the https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html[_krb5.conf_] file of the _ConfigMap_ with the service's previous Kerberos configuration is:

[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
 ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
 }
----
+
Modify it to accept Apache Impala®'s configuration. It should look like this:
+
[source,bash]
----
[libdefaults]
 default_realm=ZULU.INT
 dns_lookup_realm=false
 dns_lookup_kdc=false
 renew_lifetime=7d
 ticket_lifetime=24h
 rdns=false
 forwardable=true
 renewable=true
 default_ccache_name=/tmp/krb5cc_%{uid}
 udp_preference_limit=1
[realms]
  ZULU.INT={
   kdc=kerberos.keos-idp:88
   admin_server=kerberos.keos-idp:749
  }
  MYCOMPANY.COM={
   kdc=impala.mycompany.com:88
   admin_server = impala.mycompany.com:749
  }
[domain_realm]
 .mycompany.com = MYCOMPANY.COM
 mycompany.com = MYCOMPANY.COM
----
+
NOTE: You need to restart the service for changes to this configuration to take effect.
--

== Discover your data

=== Discovery agent

To install a _Stratio Data Governance_ discovery agent for Apache Impala® you must go to '_Stratio Command Center_' -> 'Deploy a Service' -> 'Connectors RDBMS' and select "Cloudera Impala Agent".

The fields to be filled in for the installation are:

* *_General_*:
** *_Service ID_*: agent's unique identifier. Example: _dg-mssql-agent_.
** *_Service name_*: name displayed in _Stratio KEOS_. Example: _dg-mssql-agent_.
* *Metadata Datastore (PostgreSQL®)*
** *_Host_*: the PostgreSQL® instance that stores the discovered metadata. Example: _pgbouncer-postgreskeos-governance.keos-core_.
* *Configuration of the Service to be Discovered*
** *Service to be discovered:*
*** *_Service name_*: name that will be used to identify this data store in _Stratio Data Governance_. It’s the one that will be displayed in the user interface. Example: dg-impala-agent.
*** *_Root discovery path_*: paths of the Apache Impala® schemas that you want to be discovered. For example: `/schema_to_be_discovered,/schema_to_be_discovered2`. You can use `/` to discover all schemas accessed.
+
image::configuracion_agente_impala_1.png[]
+
** *Resource datastore connection configuration*
*** *_Custom Service URL_*: Apache Impala® database connection string. It should be similar to the following example: `jdbc:hive2://your.host.com:21050/default`.
*** *_Custom data store service security_*: type of authentication used for the connection: KRB (Kerberos).
*** *_Access credentials_*: credentials name. Give it a meaningful and unique name. For example: `impala-credentials`.
*** *_SSCC driver location_*: URL where the artifact that will contain the JAR of the SSCC Apache Impala® connector is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/<path>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.
*** *_JDBC driver location_*: URL where the artifact that will contain the JAR of the selected JDBC driver is located in the connectors repository. Example: `http://connectors.<tenant>-<namespace>/<path>/v1/api/artifact/hive-jdbc-3.1.2-1.0.0-47b3295.jar`.
+
image::configuracion_agente_impala_2.png[]

Next, you must apply the Kerberos configuration following what is indicated earlier in this guide.

When the discovery process is finished, you can verify that a new data store has been discovered in the _Stratio Data Governance_ UI.

== Virtualize your data

=== Eureka agent

To use the BDL, you need to configure the Eureka agent with the Apache Impala® connector. To do this, simply add the URL of the connectors repository artifact in the 'Customized deployment' -> 'Settings' -> `Additional jars` variable: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar`.

NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.

=== _Stratio Virtualizer_

To use _Stratio Virtualizer_, the Apache Impala® connector needs to be configured. To do this, you have to upload the access credentials to _Stratio KMS_ and add the URLs of the required artifacts to the `JDBC Drivers URL List` variable in the _Stratio Virtualizer_ service modification form in _Stratio Command Center_:

* 'Customized deployment' -> 'Settings'
+
--
** _Use native SQL queries_: possible values are _True_ and _False_. _True_ if the user wants to access the data in the xref:stratio-virtualizer:user-guide:what-can-i-do-with-stratio-virtualizer.adoc#_native_queries[native dialect] of _Stratio Virtualizer_.
--

** 'Customized deployment' -> 'Environment'
+
--
** _JDBC Integration_: enabled.
** _JDBC Drivers URL List_: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/hive-jdbc-3.1.2-1.0.0-47b3295.jar`.
--
+
NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.
+
Next, you must apply the Kerberos configuration following what is indicated earlier in this guide.
+
To virtualize the SSCC Apache Impala® connector, you'll have to add some of its tables in a _Stratio Data Governance_ collection and grant permissions in _Stratio GoSec_. Once you do that, the data will be accessible in the remaining _Stratio Generative AI Data Fabric_ modules. You can see how they appear in the following image:
+
image::col_tecnica_impala.png[]

== Transform your data

=== _Stratio Rocket_

To use _Stratio Rocket_, the Apache Impala® connector must be configured. To do this:

. You have to upload the access credentials for workflows and for _Stratio Rocket_ to _Stratio KMS_.
. You have to add the URL of the artifact in the 'Customized deployment' -> 'Settings' -> 'Classpath' -> `Rocket extra jars` variable of _Stratio Command Center_.

* 'Customized deployment' -> 'Settings' -> 'Classpath'
+
--
** _Include Crossdata native connector library_: enabled.
** _Include Crossdata native engine library_: enabled.
** _Rocket extra jars_: `http://connectors.<tenant>-<namespace>/v1/api/artifact/sscc-hive-0.3_2.12-1.5.x.jar,http://connectors.<tenant>-<namespace>/v1/api/artifact/hive-jdbc-3.1.2-1.0.0-47b3295.jar`.
--
+
NOTE: Remember that, if you already have more than one artifact in the list, you have to add the following ones, separating them with a comma.
+
Next, you must apply the Kerberos configuration following what is indicated earlier in this guide.
+
In _Stratio Rocket_ the virtualized Apache Impala® collection can be accessed via SQL queries or via a workflow. The following image shows an example:
+
image::rocket1_db2.png[BDL]

=== _Stratio Intelligence_

For the correct configuration of _Stratio Intelligence_ with the Apache Impala® connector it is recommended to see the xref:apache-impala:quick-start-guide.adoc#_stratio_intelligence[_Stratio Intelligence_ section in the quick start guide], keeping in mind to use the appropriate authentication mode format for secrets.
