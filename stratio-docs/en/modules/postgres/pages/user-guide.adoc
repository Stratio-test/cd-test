= User guide

== Description

The SSCC PostgreSQL® connector allows you to fully integrate PostgreSQL® into _Stratio Generative AI Data Fabric_.

Both the supported features and the different versions are found in the xref:postgres:compatibility-matrix.adoc[compatibility matrix].

== Discover your data

=== Know your data

In addition to what xref:stratio-data-governance:user-manual:from-a-data-store-to-a-dictionary.adoc#_tables_and_columns[_Stratio Data Governance_] shows, you can also find technical attributes extracted from PostgreSQL® resources. All of the metadata provided by PostgreSQL® is extracted and added to the _Stratio Data Governance_ UI in both table and column form.

* The metadata extracted in table form are as follows:
+
image:postgres-table-metadata.png[]

* The metadata extracted in column form are as follows:
+
image:postgres-column-metadata1.png[]

NOTE: Views in PostgreSQL® are supported, but are shown as tables in the _Stratio Data Governance_ UI.

=== Discovery with automatic optimization

The optimization performed by the SSCC PostgreSQL® agent is performed at the same time as the discovery on the same PostgreSQL® data hierarchy, provided that the automatic optimization option has been enabled during the discovery agent configuration process.

The agent, in addition to those added during the discovery process, will associate technical or system metadata to the levels of the data hierarchy related to the table optimization:

. *_Table_*, accessible through the "System attributes" button or the "Connector Attributes" link:
** _sscc.optimizer.partitionColumn_: column used to partition the table.
** _sscc.optimizer.lowerBound_: lower limit of the partition.
** _sscc.optimizer.upperBound_: upper limit of the partition.
** _sscc.optimizer.numPartitions_: number of partitions to be used to partition the table.
** _sscc.optimizer.count_: number of rows in the table.
+
image::postgres-optimizer-table-attrs.png[]

. *_Column_*, accessible through the "System attributes" button or the "Connector Attributes" link, after selecting it in the list.
** _DensityRatio_: column density ratio. It calculates how well the column values are distributed. A value close to 1 or greater indicates that the values are poorly distributed, while a value close to 0 indicates that the values are well distributed.
** _MaxValue_: maximum value of the column.
** _MinValue_: minimum value of the column.
** _NullValues_: number of null values in the column.
** _DistinctValues_: number of distinct values in the column.
+
image::postgres-optimizer-column-attrs.png[]
+
NOTE: Not all column optimization metadata is available in the _Stratio Data Governance_ UI. This is due to the _Granularity optimization level_ chosen during the discovery agent configuration process.

=== Manual optimization

This functionality allows you to manually optimize the discovered tables. Manual optimization can be performed regardless of whether or not the automatic optimization option has been enabled during the discovery agent configuration process.

To optimize a table manually, you can add the following attributes to the table in the BDL during the virtualization process in the creation of the _Data Collections_:

* *bdl.options.partitionColumn*: column used to partition the table.
* *bdl.options.lowerBound*: lower limit of the partition.
* *bdl.options.upperBound*: upper limit of the partition.
* *bdl.options.numPartitions*: number of partitions to be used to partition the table.

NOTE: The table optimization attributes by manual optimization will prevail and take precedence over the discovered table optimization attributes.

TIP: You can read more about its features in its xref:stratio-virtualizer:user-guide:user-guide.adoc#_working_with_stratio_virtualizer[user guide].

=== BDL virtualization

The discovery process is asynchronous. Once completed, it can be viewed from the _Stratio Data Governance_ UI.

The connector supports xref:stratio-data-governance:user-manual:semantic-mapping.adoc[semantic mapping] using operational mode.

The connector supports customization of data access in virtualized tables using xref:stratio-data-governance:user-manual:bdl-virtualization.adoc#_bdl_custom_attributes[BDL custom attributes].

NOTE: You can consult how to create attributes in the xref:stratio-data-governance:user-manual/addition-of-metadata[_Stratio Data Governance_ user guide].

TIP: For more details on the use of the BDL, see the xref:stratio-data-governance:user-manual:data-processing-with-bdl.adoc[BDL data processing documentation].

== Virtualize your data

After tables have been discovered, you can add them to a technical view of a collection. All the configurable parameters of the discovery and those parameters modified from the _Stratio Data Governance_ UI are propagated in the collections where that table is added.

TIP: To learn more about how to manage collections you can consult the xref:stratio-data-governance:user-manual:collections.adoc[_Stratio Data Governance_ user guide].

IMPORTANT: Note that to virtualize the discovered tables, you need to manage the xref:stratio-gosec:operations-manual:data-access/manage-policies/manage-domains-policies.adoc[domain policies] through _Stratio GoSec_.

To create a table directly in the _Stratio Virtualizer_ catalog, you can execute the following statements:

* If you want to create the table for any authentication method *without native mode*:
+
[source,sql]
----
CREATE TABLE postgresql_table USING jdbc OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccpostgresql.PostgreSQLDriver<service_security>',
    `driver` 'embedded.com.stratio.connectors.ssccpostgresql.org.postgresql.Driver',
    `url` '<service_url>',
    `dbtable` '<schema_name>.<table_name>'
)
----

* If you want to create the table for any authentication method *with native mode*:
+
[source,sql]
----
CREATE TABLE postgresql_table USING com.stratio.crossdata.connector.postgresql OPTIONS (
    `stratiosecurity` 'true',
    `stratiosecuritymode` 'custom_sscc',
    `stratiocredentials` '<secret_name>',
    `stratiossccdriver` 'com.stratio.connectors.ssccpostgresql.PostgreSQLDriver<service_security>',
    `driver` 'embedded.com.stratio.connectors.ssccpostgresql.org.postgresql.Driver',
    `url` '<service_url>',
    `dbtable` '<schema_name>.<table_name>'
)
----

=== Native PostgreSQL® access

The connector includes an implementation of the xref:stratio-virtualizer:architecture:features.adoc#_native_access_to_data_stores[native dialect of _Stratio Virtualizer_]. You can check how to configure it globally in its xref:stratio-virtualizer:operations-guide:configuration/processing-configuration.adoc#_improvements_from_stratio_{modulename}_to_sparks_push_down[operations guide].

TIP: To check if a catalog table supports the native dialect, you can check its provider: the result of the `show create table my_table` statement must contain "using com.stratio.crossdata.connector.postgresql".

The native dialect supports a subset of the https://archive.apache.org/dist/spark/docs/3.1.1/sql-ref.html[Apache Spark™ SQL dialect]. Unsupported statements could still be executed but without performing the full push-down provided by the native dialect, so performance may suffer for tables with a large number of rows.

TIP: You can check the subset of the supported SQL dialect in xref:postgres:user-guide/native-coverage.adoc[the native dialect coverage reference].

=== _Stratio Rocket_

After the data has been virtualized, you can access it from _Stratio Rocket_ using:

* The catalog.
+
image:postgres-rocket-catalog.png[]

* In the workflows using the input from xref:stratio-rocket:user-guide:workflow-asset/data-inputs.adoc#_stratio_virtualizer[_Stratio Virtualizer_]. You can force access through the native dialect by checking the "Force query execution with native connectors" box.
+
image:postgres-rocket-virtualizer-input.png[]

=== _Stratio Intelligence_

You can see how the data is accessed from _Stratio Intelligence_ in the xref:ROOT:quick-start-guide.adoc#_stratio_intelligence[general quick start guide].
